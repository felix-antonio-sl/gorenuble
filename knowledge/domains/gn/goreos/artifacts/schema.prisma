// GORE_OS - Schema Prisma
// Generado desde: kb_goreos_201_modelo_logico_prisma_koda.yml
// Fecha: 2024-12-14

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis, uuid_ossp]
}

// ═══════════════════════════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum TipoUsuario {
  FUNCIONARIO
  EXTERNO_MUNICIPIO
  EXTERNO_SERVICIO
  EXTERNO_OTRO
  CIUDADANO
}

enum EstadoUsuario {
  ACTIVO
  INACTIVO
  BLOQUEADO
  PENDIENTE
}

enum CalidadJuridica {
  PLANTA
  CONTRATA
  HONORARIOS
  CODIGO_TRABAJO
}

enum TipoActor {
  MUNICIPALIDAD
  SERVICIO_PUBLICO
  UNIVERSIDAD
  ONG
  FUNDACION
  CORPORACION
  EMPRESA_PUBLICA
  EMPRESA_PRIVADA
  COOPERATIVA
  OTRO
}

enum ClasificacionUE {
  A
  B
  C
  D
  SIN_CLASIFICAR
}

enum TipoUnidad {
  GABINETE
  DIVISION
  DEPARTAMENTO
  UNIDAD
  SECCION
  OFICINA
}

enum TipoTerritorio {
  PAIS
  REGION
  PROVINCIA
  COMUNA
  DISTRITO
  LOCALIDAD
}

enum TipoPeriodo {
  ANUAL
  SEMESTRE
  TRIMESTRE
  MES
  SEMANA
}

enum TipoIniciativa {
  PROYECTO
  PROGRAMA
  ESTUDIO_BASICO
  ESTUDIO_PREINVERSION
}

enum EstadoIniciativa {
  IDEA
  PERFIL
  PERFIL_TERMINADO
  PREFACTIBILIDAD
  FACTIBILIDAD
  DISENO
  SIN_RS
  EN_EVALUACION_RS
  CON_RS
  RS_VENCIDA
  PRIORIZADA
  EN_SESION_CORE
  APROBADA_CORE
  RECHAZADA_CORE
  EN_EJECUCION
  FINALIZADA
  SUSPENDIDA
  CANCELADA
}

enum TipoInstrumento {
  FNDR
  FRIL
  PMU
  PMB
  FRPD
  CONV_PROG
  SUBVENCION
  FIC
  FAGEM
  OTRO
}

enum EstadoSolicitud {
  BORRADOR
  PRESENTADA
  EN_EVALUACION
  ELEGIBLE
  NO_ELEGIBLE
  PRIORIZADA
  NO_PRIORIZADA
  EN_SESION_CORE
  APROBADA_CORE
  RECHAZADA_CORE
  DESISTIDA
}

enum TipoConvenio {
  MANDATO
  TRANSFERENCIA
  COLABORACION
  MARCO
  ESPECIFICO
}

enum EstadoConvenio {
  BORRADOR
  EN_REVISION_JURIDICA
  EN_REVISION_TECNICA
  PARA_FIRMA
  VIGENTE
  EN_MODIFICACION
  EN_LIQUIDACION
  LIQUIDADO
  CADUCADO
  RESCILIADO
}

enum Semaforo {
  VERDE
  AMARILLO
  ROJO
  GRIS
}

enum EstadoHito {
  PENDIENTE
  EN_PROCESO
  CUMPLIDO
  ATRASADO
  REPROGRAMADO
  CANCELADO
}

enum EstadoDesembolso {
  PROGRAMADO
  SOLICITADO
  EN_PROCESO
  TRANSFERIDO
  ANULADO
}

enum EstadoRendicion {
  PENDIENTE
  RECIBIDA
  EN_REVISION
  OBSERVADA
  APROBADA
  APROBADA_CON_OBSERVACIONES
  RECHAZADA
}

enum TipoDocRendicion {
  FACTURA
  FACTURA_ELECTRONICA
  BOLETA
  BOLETA_HONORARIOS
  VOUCHER
  PLANILLA
  VALE
  OTRO
}

enum EstadoMovimiento {
  PENDIENTE
  VALIDO
  OBSERVADO
  RECHAZADO
}

enum TipoOKR {
  ORGANIZACIONAL
  DIVISION
  UNIDAD
}

enum EstadoOKR {
  BORRADOR
  ACTIVO
  CERRADO
  CANCELADO
}

enum EstadoKR {
  EN_RIESGO
  EN_TRACK
  LOGRADO
  NO_LOGRADO
}

enum SeveridadAlerta {
  INFO
  WARNING
  CRITICAL
}

enum EstadoAlerta {
  ACTIVA
  EN_ATENCION
  RESUELTA
  ESCALADA
  IGNORADA
}

// ═══════════════════════════════════════════════════════════════════════════════
// ENTIDADES MAESTRAS
// ═══════════════════════════════════════════════════════════════════════════════

model Usuario {
  id                String        @id @default(uuid()) @db.Uuid
  rut               String        @unique @db.VarChar(12)
  nombres           String        @db.VarChar(100)
  apellidoPaterno   String        @map("apellido_paterno") @db.VarChar(100)
  apellidoMaterno   String?       @map("apellido_materno") @db.VarChar(100)
  email             String        @unique @db.VarChar(255)
  emailAlternativo  String?       @map("email_alternativo") @db.VarChar(255)
  telefono          String?       @db.VarChar(20)
  tipo              TipoUsuario
  estado            EstadoUsuario @default(PENDIENTE)
  actorId           String?       @map("actor_id") @db.Uuid
  fechaUltimoAcceso DateTime?     @map("fecha_ultimo_acceso")
  intentosFallidos  Int           @default(0) @map("intentos_fallidos")
  preferencias      Json?
  createdAt         DateTime      @default(now()) @map("created_at")
  createdBy         String?       @map("created_by") @db.Uuid
  updatedAt         DateTime      @updatedAt @map("updated_at")
  deletedAt         DateTime?     @map("deleted_at")

  actor       Actor?        @relation(fields: [actorId], references: [id])
  funcionario Funcionario?
  roles       RolUsuario[]

  @@index([tipo, estado])
  @@index([actorId])
  @@map("usuarios")
}

model Funcionario {
  id              String          @id @default(uuid()) @db.Uuid
  usuarioId       String          @unique @map("usuario_id") @db.Uuid
  unidadId        String          @map("unidad_id") @db.Uuid
  cargo           String          @db.VarChar(200)
  grado           String?         @db.VarChar(10)
  estamento       String?         @db.VarChar(50)
  calidadJuridica CalidadJuridica @map("calidad_juridica")
  fechaIngreso    DateTime        @map("fecha_ingreso") @db.Date
  fechaTermino    DateTime?       @map("fecha_termino") @db.Date
  jefatura        Boolean         @default(false)
  jefeId          String?         @map("jefe_id") @db.Uuid
  firmaElectronica Boolean        @default(false) @map("firma_electronica")
  activo          Boolean         @default(true)
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  usuario      Usuario        @relation(fields: [usuarioId], references: [id])
  unidad       UnidadOrganica @relation(fields: [unidadId], references: [id])
  jefe         Funcionario?   @relation("JefeSubordinado", fields: [jefeId], references: [id])
  subordinados Funcionario[]  @relation("JefeSubordinado")

  @@index([unidadId, activo])
  @@map("funcionarios")
}

model Actor {
  id                  String          @id @default(uuid()) @db.Uuid
  rut                 String          @unique @db.VarChar(12)
  nombre              String          @db.VarChar(255)
  nombreCorto         String?         @map("nombre_corto") @db.VarChar(50)
  tipo                TipoActor
  subtipo             String?         @db.VarChar(100)
  territorioId        String?         @map("territorio_id") @db.Uuid
  direccion           String?         @db.VarChar(500)
  telefono            String?         @db.VarChar(20)
  emailInstitucional  String?         @map("email_institucional") @db.VarChar(255)
  sitioWeb            String?         @map("sitio_web") @db.VarChar(255)
  representanteLegal  String?         @map("representante_legal") @db.VarChar(200)
  esUnidadEjecutora   Boolean         @default(false) @map("es_unidad_ejecutora")
  esBeneficiario      Boolean         @default(true) @map("es_beneficiario")
  clasificacionUE     ClasificacionUE @default(SIN_CLASIFICAR) @map("clasificacion_ue")
  conveniosEjecutados Int             @default(0) @map("convenios_ejecutados")
  montoHistorico      Decimal         @default(0) @map("monto_historico") @db.Decimal(18, 0)
  activo              Boolean         @default(true)
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  territorio        Territorio?  @relation(fields: [territorioId], references: [id])
  usuarios          Usuario[]
  iniciativas       Iniciativa[]
  conveniosEjecutor Convenio[]

  @@index([tipo, activo])
  @@index([esUnidadEjecutora, clasificacionUE])
  @@map("actores")
}

model UnidadOrganica {
  id          String     @id @default(uuid()) @db.Uuid
  codigo      String     @unique @db.VarChar(20)
  nombre      String     @db.VarChar(200)
  nombreCorto String?    @map("nombre_corto") @db.VarChar(50)
  sigla       String?    @db.VarChar(10)
  tipo        TipoUnidad
  nivel       Int
  parentId    String?    @map("parent_id") @db.Uuid
  jefeId      String?    @map("jefe_id") @db.Uuid
  email       String?    @db.VarChar(255)
  telefono    String?    @db.VarChar(20)
  funcion     String?    @db.Text
  path        String?    @db.VarChar(500)
  orden       Int        @default(0)
  activo      Boolean    @default(true)
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  padre        UnidadOrganica?  @relation("UnidadPadreHijo", fields: [parentId], references: [id])
  hijos        UnidadOrganica[] @relation("UnidadPadreHijo")
  funcionarios Funcionario[]
  okrs         OKR[]

  @@index([parentId, orden])
  @@index([tipo, activo])
  @@map("unidades_organicas")
}

model Territorio {
  id                  String         @id @default(uuid()) @db.Uuid
  codigoCut           String         @unique @map("codigo_cut") @db.VarChar(10)
  nombre              String         @db.VarChar(100)
  nombreOficial       String?        @map("nombre_oficial") @db.VarChar(200)
  tipo                TipoTerritorio
  parentId            String?        @map("parent_id") @db.Uuid
  superficieKm2       Decimal?       @map("superficie_km2") @db.Decimal(12, 2)
  poblacion           Int?
  anioPoblacion       Int?           @map("anio_poblacion")
  esCapitalRegional   Boolean        @default(false) @map("es_capital_regional")
  esCapitalProvincial Boolean        @default(false) @map("es_capital_provincial")
  activo              Boolean        @default(true)
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  padre       Territorio?  @relation("TerritorioPadreHijo", fields: [parentId], references: [id])
  hijos       Territorio[] @relation("TerritorioPadreHijo")
  actores     Actor[]
  iniciativas Iniciativa[]

  @@index([tipo, parentId])
  @@map("territorios")
}

model Periodo {
  id          String      @id @default(uuid()) @db.Uuid
  codigo      String      @unique @db.VarChar(20)
  tipo        TipoPeriodo
  anio        Int
  semestre    Int?
  trimestre   Int?
  mes         Int?
  semana      Int?
  fechaInicio DateTime    @map("fecha_inicio") @db.Date
  fechaFin    DateTime    @map("fecha_fin") @db.Date
  esActual    Boolean     @default(false) @map("es_actual")
  cerrado     Boolean     @default(false)
  fechaCierre DateTime?   @map("fecha_cierre")
  createdAt   DateTime    @default(now()) @map("created_at")

  presupuestos Presupuesto[]
  okrs         OKR[]

  @@index([tipo, anio])
  @@index([esActual, tipo])
  @@map("periodos")
}

model Rol {
  id          String       @id @default(uuid()) @db.Uuid
  codigo      String       @unique @db.VarChar(50)
  nombre      String       @db.VarChar(100)
  descripcion String?      @db.Text
  permisos    Json
  esSistema   Boolean      @default(false) @map("es_sistema")
  activo      Boolean      @default(true)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  usuarios RolUsuario[]

  @@map("roles")
}

model RolUsuario {
  id        String    @id @default(uuid()) @db.Uuid
  usuarioId String    @map("usuario_id") @db.Uuid
  rolId     String    @map("rol_id") @db.Uuid
  ambito    String?   @db.VarChar(100)
  fechaDesde DateTime @map("fecha_desde") @db.Date
  fechaHasta DateTime? @map("fecha_hasta") @db.Date
  createdAt DateTime  @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuarioId], references: [id])
  rol     Rol     @relation(fields: [rolId], references: [id])

  @@unique([usuarioId, rolId, ambito])
  @@map("roles_usuarios")
}

// ═══════════════════════════════════════════════════════════════════════════════
// D-FIN: FINANCIAMIENTO
// ═══════════════════════════════════════════════════════════════════════════════

model Iniciativa {
  id                    String           @id @default(uuid()) @db.Uuid
  codigoInterno         String           @unique @map("codigo_interno") @db.VarChar(20)
  codigoBip             String?          @unique @map("codigo_bip") @db.VarChar(15)
  nombre                String           @db.VarChar(500)
  descripcion           String?          @db.Text
  tipo                  TipoIniciativa
  subtipo               String?          @db.VarChar(100)
  sector                String           @db.VarChar(100)
  subsector             String?          @db.VarChar(100)
  costoTotal            Decimal          @map("costo_total") @db.Decimal(18, 0)
  costoActualizado      Decimal?         @map("costo_actualizado") @db.Decimal(18, 0)
  estado                EstadoIniciativa @default(IDEA)
  beneficiarioId        String           @map("beneficiario_id") @db.Uuid
  territorioId          String           @map("territorio_id") @db.Uuid
  fechaRs               DateTime?        @map("fecha_rs") @db.Date
  numeroRs              String?          @map("numero_rs") @db.VarChar(50)
  montoRs               Decimal?         @map("monto_rs") @db.Decimal(18, 0)
  vigenciaRs            DateTime?        @map("vigencia_rs") @db.Date
  poblacionBeneficiaria Int?             @map("poblacion_beneficiaria")
  prioridadRegional     Int?             @map("prioridad_regional")
  createdBy             String?          @map("created_by") @db.Uuid
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  beneficiario Actor                     @relation(fields: [beneficiarioId], references: [id])
  territorio   Territorio                @relation(fields: [territorioId], references: [id])
  solicitudes  SolicitudFinanciamiento[]
  convenios    Convenio[]

  @@index([estado])
  @@index([beneficiarioId])
  @@index([territorioId])
  @@index([sector, subsector])
  @@map("iniciativas")
}

model InstrumentoFinanciamiento {
  id            String          @id @default(uuid()) @db.Uuid
  codigo        String          @unique @db.VarChar(20)
  nombre        String          @db.VarChar(200)
  nombreCorto   String?         @map("nombre_corto") @db.VarChar(50)
  descripcion   String?         @db.Text
  tipo          TipoInstrumento
  subtipoPresup String          @map("subtipo_presup") @db.VarChar(10)
  requiereRs    Boolean         @default(true) @map("requiere_rs")
  requiereCore  Boolean         @default(true) @map("requiere_core")
  montoMaximo   Decimal?        @map("monto_maximo") @db.Decimal(18, 0)
  montoMinimo   Decimal?        @map("monto_minimo") @db.Decimal(18, 0)
  elegibilidad  Json?
  vigente       Boolean         @default(true)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  solicitudes          SolicitudFinanciamiento[]
  itemsPresupuestarios ItemPresupuestario[]

  @@map("instrumentos_financiamiento")
}

model SolicitudFinanciamiento {
  id                  String          @id @default(uuid()) @db.Uuid
  codigo              String          @unique @db.VarChar(30)
  iniciativaId        String          @map("iniciativa_id") @db.Uuid
  instrumentoId       String          @map("instrumento_id") @db.Uuid
  priorizacionId      String?         @map("priorizacion_id") @db.Uuid
  anioSolicitado      Int             @map("anio_solicitado")
  montoSolicitado     Decimal         @map("monto_solicitado") @db.Decimal(18, 0)
  montoAprobado       Decimal?        @map("monto_aprobado") @db.Decimal(18, 0)
  estado              EstadoSolicitud @default(BORRADOR)
  fechaPresentacion   DateTime?       @map("fecha_presentacion") @db.Date
  puntajeEvaluacion   Decimal?        @map("puntaje_evaluacion") @db.Decimal(5, 2)
  rankingPriorizacion Int?            @map("ranking_priorizacion")
  fechaSesionCore     DateTime?       @map("fecha_sesion_core") @db.Date
  acuerdoCore         String?         @map("acuerdo_core") @db.VarChar(50)
  observaciones       String?         @db.Text
  motivoRechazo       String?         @map("motivo_rechazo") @db.Text
  createdBy           String?         @map("created_by") @db.Uuid
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  iniciativa   Iniciativa                @relation(fields: [iniciativaId], references: [id])
  instrumento  InstrumentoFinanciamiento @relation(fields: [instrumentoId], references: [id])
  priorizacion Priorizacion?             @relation(fields: [priorizacionId], references: [id])

  @@unique([iniciativaId, instrumentoId, anioSolicitado])
  @@index([estado])
  @@index([instrumentoId, anioSolicitado])
  @@map("solicitudes_financiamiento")
}

model Presupuesto {
  id                  String   @id @default(uuid()) @db.Uuid
  periodoId           String   @map("periodo_id") @db.Uuid
  tipo                String   @db.VarChar(20)
  version             Int      @default(1)
  montoTotal          Decimal  @map("monto_total") @db.Decimal(18, 0)
  montoInversion      Decimal  @map("monto_inversion") @db.Decimal(18, 0)
  montoFuncionamiento Decimal  @map("monto_funcionamiento") @db.Decimal(18, 0)
  fechaAprobacion     DateTime? @map("fecha_aprobacion") @db.Date
  resolucion          String?  @db.VarChar(50)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  periodo Periodo              @relation(fields: [periodoId], references: [id])
  items   ItemPresupuestario[]

  @@unique([periodoId, tipo, version])
  @@map("presupuestos")
}

model ItemPresupuestario {
  id                String   @id @default(uuid()) @db.Uuid
  presupuestoId     String   @map("presupuesto_id") @db.Uuid
  instrumentoId     String?  @map("instrumento_id") @db.Uuid
  subtitulo         String   @db.VarChar(10)
  item              String   @db.VarChar(10)
  asignacion        String?  @db.VarChar(10)
  descripcion       String   @db.VarChar(500)
  montoInicial      Decimal  @map("monto_inicial") @db.Decimal(18, 0)
  montoVigente      Decimal  @map("monto_vigente") @db.Decimal(18, 0)
  montoComprometido Decimal  @default(0) @map("monto_comprometido") @db.Decimal(18, 0)
  montoDevengado    Decimal  @default(0) @map("monto_devengado") @db.Decimal(18, 0)
  montoPagado       Decimal  @default(0) @map("monto_pagado") @db.Decimal(18, 0)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  presupuesto Presupuesto                @relation(fields: [presupuestoId], references: [id])
  instrumento InstrumentoFinanciamiento? @relation(fields: [instrumentoId], references: [id])

  @@unique([presupuestoId, subtitulo, item, asignacion])
  @@map("items_presupuestarios")
}

model Priorizacion {
  id                  String   @id @default(uuid()) @db.Uuid
  codigo              String   @unique @db.VarChar(30)
  nombre              String   @db.VarChar(200)
  anio                Int
  instrumentoId       String?  @map("instrumento_id") @db.Uuid
  fechaInicio         DateTime @map("fecha_inicio") @db.Date
  fechaCierre         DateTime @map("fecha_cierre") @db.Date
  estado              String   @default("PROGRAMADA") @db.VarChar(20)
  criteriosEvaluacion Json?    @map("criterios_evaluacion")
  marcoPresupuestario Decimal? @map("marco_presupuestario") @db.Decimal(18, 0)
  totalSolicitado     Decimal  @default(0) @map("total_solicitado") @db.Decimal(18, 0)
  totalAprobado       Decimal  @default(0) @map("total_aprobado") @db.Decimal(18, 0)
  cantidadSolicitudes Int      @default(0) @map("cantidad_solicitudes")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  solicitudes SolicitudFinanciamiento[]

  @@index([anio, instrumentoId])
  @@map("priorizaciones")
}

// ═══════════════════════════════════════════════════════════════════════════════
// D-EJEC: EJECUCIÓN
// ═══════════════════════════════════════════════════════════════════════════════

model Convenio {
  id                    String         @id @default(uuid()) @db.Uuid
  numero                String         @unique @db.VarChar(30)
  iniciativaId          String         @map("iniciativa_id") @db.Uuid
  unidadEjecutoraId     String         @map("unidad_ejecutora_id") @db.Uuid
  tipo                  TipoConvenio
  objeto                String         @db.Text
  montoTotal            Decimal        @map("monto_total") @db.Decimal(18, 0)
  aporteGore            Decimal        @map("aporte_gore") @db.Decimal(18, 0)
  aporteEjecutor        Decimal        @default(0) @map("aporte_ejecutor") @db.Decimal(18, 0)
  fechaSuscripcion      DateTime?      @map("fecha_suscripcion") @db.Date
  fechaInicio           DateTime       @map("fecha_inicio") @db.Date
  fechaTerminoOriginal  DateTime       @map("fecha_termino_original") @db.Date
  fechaTerminoVigente   DateTime       @map("fecha_termino_vigente") @db.Date
  plazoMeses            Int            @map("plazo_meses")
  estado                EstadoConvenio @default(BORRADOR)
  resolucionAprobatoria String?        @map("resolucion_aprobatoria") @db.VarChar(50)
  montoTransferido      Decimal        @default(0) @map("monto_transferido") @db.Decimal(18, 0)
  montoRendido          Decimal        @default(0) @map("monto_rendido") @db.Decimal(18, 0)
  montoAprobado         Decimal        @default(0) @map("monto_aprobado") @db.Decimal(18, 0)
  avanceFisico          Decimal        @default(0) @map("avance_fisico") @db.Decimal(5, 2)
  avanceFinanciero      Decimal        @default(0) @map("avance_financiero") @db.Decimal(5, 2)
  semaforo              Semaforo       @default(GRIS)
  supervisorId          String?        @map("supervisor_id") @db.Uuid
  documentoUrl          String?        @map("documento_url") @db.VarChar(500)
  createdBy             String?        @map("created_by") @db.Uuid
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  iniciativa      Iniciativa     @relation(fields: [iniciativaId], references: [id])
  unidadEjecutora Actor          @relation(fields: [unidadEjecutoraId], references: [id])
  hitos           HitoConvenio[]
  desembolsos     Desembolso[]
  addendums       Addendum[]
  rendiciones     Rendicion[]
  proyectoPmo     ProyectoPMO?

  @@index([estado])
  @@index([unidadEjecutoraId])
  @@index([semaforo])
  @@map("convenios")
}

model HitoConvenio {
  id                String     @id @default(uuid()) @db.Uuid
  convenioId        String     @map("convenio_id") @db.Uuid
  numero            Int
  nombre            String     @db.VarChar(200)
  descripcion       String?    @db.Text
  tipo              String     @db.VarChar(50)
  fechaProgramada   DateTime   @map("fecha_programada") @db.Date
  fechaCumplimiento DateTime?  @map("fecha_cumplimiento") @db.Date
  montoAsociado     Decimal    @default(0) @map("monto_asociado") @db.Decimal(18, 0)
  porcentajeAvance  Decimal    @default(0) @map("porcentaje_avance") @db.Decimal(5, 2)
  estado            EstadoHito @default(PENDIENTE)
  evidenciaUrl      String?    @map("evidencia_url") @db.VarChar(500)
  observaciones     String?    @db.Text
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  convenio   Convenio    @relation(fields: [convenioId], references: [id])
  desembolso Desembolso?

  @@unique([convenioId, numero])
  @@index([estado])
  @@map("hitos_convenio")
}

model Desembolso {
  id                 String           @id @default(uuid()) @db.Uuid
  convenioId         String           @map("convenio_id") @db.Uuid
  hitoId             String?          @unique @map("hito_id") @db.Uuid
  numeroCuota        Int              @map("numero_cuota")
  descripcion        String?          @db.VarChar(255)
  monto              Decimal          @db.Decimal(18, 0)
  porcentajeConvenio Decimal          @map("porcentaje_convenio") @db.Decimal(5, 2)
  fechaProgramada    DateTime         @map("fecha_programada") @db.Date
  fechaSolicitud     DateTime?        @map("fecha_solicitud") @db.Date
  fechaTransferencia DateTime?        @map("fecha_transferencia") @db.Date
  estado             EstadoDesembolso @default(PROGRAMADO)
  comprobanteTransf  String?          @map("comprobante_transf") @db.VarChar(100)
  numeroOperacion    String?          @map("numero_operacion") @db.VarChar(50)
  observaciones      String?          @db.Text
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  convenio Convenio      @relation(fields: [convenioId], references: [id])
  hito     HitoConvenio? @relation(fields: [hitoId], references: [id])

  @@unique([convenioId, numeroCuota])
  @@index([estado])
  @@map("desembolsos")
}

model Addendum {
  id                 String   @id @default(uuid()) @db.Uuid
  convenioId         String   @map("convenio_id") @db.Uuid
  numero             Int
  tipo               String   @db.VarChar(50)
  motivo             String   @db.Text
  descripcionCambios String?  @map("descripcion_cambios") @db.Text
  fechaSolicitud     DateTime? @map("fecha_solicitud") @db.Date
  fechaSuscripcion   DateTime? @map("fecha_suscripcion") @db.Date
  resolucion         String?  @db.VarChar(50)
  nuevaFechaTermino  DateTime? @map("nueva_fecha_termino") @db.Date
  diasProrroga       Int?     @map("dias_prorroga")
  montoModificacion  Decimal? @map("monto_modificacion") @db.Decimal(18, 0)
  estado             String   @default("BORRADOR") @db.VarChar(20)
  documentoUrl       String?  @map("documento_url") @db.VarChar(500)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  convenio Convenio @relation(fields: [convenioId], references: [id])

  @@unique([convenioId, numero])
  @@map("addendums")
}

model Rendicion {
  id                 String          @id @default(uuid()) @db.Uuid
  convenioId         String          @map("convenio_id") @db.Uuid
  numero             Int
  tipo               String          @default("PARCIAL") @db.VarChar(20)
  periodoDesde       DateTime        @map("periodo_desde") @db.Date
  periodoHasta       DateTime        @map("periodo_hasta") @db.Date
  fechaPresentacion  DateTime?       @map("fecha_presentacion") @db.Date
  fechaRecepcion     DateTime?       @map("fecha_recepcion") @db.Date
  montoRendido       Decimal         @map("monto_rendido") @db.Decimal(18, 0)
  montoAprobado      Decimal         @default(0) @map("monto_aprobado") @db.Decimal(18, 0)
  montoObservado     Decimal         @default(0) @map("monto_observado") @db.Decimal(18, 0)
  montoRechazado     Decimal         @default(0) @map("monto_rechazado") @db.Decimal(18, 0)
  cantidadDocumentos Int             @default(0) @map("cantidad_documentos")
  estado             EstadoRendicion @default(PENDIENTE)
  fechaRevision      DateTime?       @map("fecha_revision") @db.Date
  fechaCierre        DateTime?       @map("fecha_cierre") @db.Date
  revisorId          String?         @map("revisor_id") @db.Uuid
  observacionesGen   String?         @map("observaciones_gen") @db.Text
  diasMora           Int             @default(0) @map("dias_mora")
  enMora             Boolean         @default(false) @map("en_mora")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")

  convenio    Convenio              @relation(fields: [convenioId], references: [id])
  movimientos MovimientoRendicion[]

  @@unique([convenioId, numero])
  @@index([estado])
  @@index([enMora])
  @@map("rendiciones")
}

model MovimientoRendicion {
  id              String           @id @default(uuid()) @db.Uuid
  rendicionId     String           @map("rendicion_id") @db.Uuid
  numeroLinea     Int              @map("numero_linea")
  tipoDocumento   TipoDocRendicion @map("tipo_documento")
  numeroDocumento String           @map("numero_documento") @db.VarChar(50)
  fechaDocumento  DateTime         @map("fecha_documento") @db.Date
  proveedorRut    String           @map("proveedor_rut") @db.VarChar(12)
  proveedorNombre String           @map("proveedor_nombre") @db.VarChar(200)
  descripcion     String           @db.VarChar(500)
  categoriaGasto  String?          @map("categoria_gasto") @db.VarChar(100)
  montoNeto       Decimal          @map("monto_neto") @db.Decimal(18, 0)
  montoIva        Decimal          @default(0) @map("monto_iva") @db.Decimal(18, 0)
  montoTotal      Decimal          @map("monto_total") @db.Decimal(18, 0)
  estado          EstadoMovimiento @default(PENDIENTE)
  motivoObservacion String?        @map("motivo_observacion") @db.Text
  documentoUrl    String?          @map("documento_url") @db.VarChar(500)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  rendicion Rendicion @relation(fields: [rendicionId], references: [id])

  @@unique([rendicionId, numeroLinea])
  @@index([tipoDocumento, numeroDocumento])
  @@index([estado])
  @@map("movimientos_rendicion")
}

model ProyectoPMO {
  id               String   @id @default(uuid()) @db.Uuid
  convenioId       String   @unique @map("convenio_id") @db.Uuid
  codigoPmo        String   @unique @map("codigo_pmo") @db.VarChar(20)
  nombre           String   @db.VarChar(255)
  gerenteProyecto  String?  @map("gerente_proyecto") @db.VarChar(200)
  fechaInicioReal  DateTime? @map("fecha_inicio_real") @db.Date
  fechaFinEstimada DateTime? @map("fecha_fin_estimada") @db.Date
  avanceFisico     Decimal  @default(0) @map("avance_fisico") @db.Decimal(5, 2)
  avanceFinanciero Decimal  @default(0) @map("avance_financiero") @db.Decimal(5, 2)
  avanceProgramado Decimal  @default(0) @map("avance_programado") @db.Decimal(5, 2)
  desviacionTiempo Int      @default(0) @map("desviacion_tiempo")
  desviacionCosto  Decimal  @default(0) @map("desviacion_costo") @db.Decimal(18, 0)
  semaforo         Semaforo @default(GRIS)
  semaforoTiempo   Semaforo @default(VERDE) @map("semaforo_tiempo")
  semaforoCosto    Semaforo @default(VERDE) @map("semaforo_costo")
  semaforoAlcance  Semaforo @default(VERDE) @map("semaforo_alcance")
  alertasActivas   Int      @default(0) @map("alertas_activas")
  ultimoReporte    DateTime? @map("ultimo_reporte") @db.Date
  observaciones    String?  @db.Text
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  convenio Convenio         @relation(fields: [convenioId], references: [id])
  alertas  AlertaProyecto[]

  @@index([semaforo])
  @@map("proyectos_pmo")
}

model AlertaProyecto {
  id              String    @id @default(uuid()) @db.Uuid
  proyectoPmoId   String    @map("proyecto_pmo_id") @db.Uuid
  tipo            String    @db.VarChar(50)
  severidad       String    @db.VarChar(20)
  titulo          String    @db.VarChar(200)
  descripcion     String    @db.Text
  fechaGeneracion DateTime  @map("fecha_generacion")
  fechaAtencion   DateTime? @map("fecha_atencion")
  estado          String    @default("ACTIVA") @db.VarChar(20)
  asignadoA       String?   @map("asignado_a") @db.Uuid
  accionTomada    String?   @map("accion_tomada") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")

  proyectoPmo ProyectoPMO @relation(fields: [proyectoPmoId], references: [id])

  @@index([estado, severidad])
  @@map("alertas_proyecto")
}

// ═══════════════════════════════════════════════════════════════════════════════
// D-GESTION: GESTIÓN INSTITUCIONAL
// ═══════════════════════════════════════════════════════════════════════════════

model OKR {
  id          String    @id @default(uuid()) @db.Uuid
  codigo      String    @unique @db.VarChar(30)
  titulo      String    @db.VarChar(300)
  descripcion String?   @db.Text
  tipo        TipoOKR
  periodoId   String    @map("periodo_id") @db.Uuid
  unidadId    String?   @map("unidad_id") @db.Uuid
  parentId    String?   @map("parent_id") @db.Uuid
  ownerId     String    @map("owner_id") @db.Uuid
  estado      EstadoOKR @default(BORRADOR)
  progreso    Decimal   @default(0) @db.Decimal(5, 2)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  periodo    Periodo         @relation(fields: [periodoId], references: [id])
  unidad     UnidadOrganica? @relation(fields: [unidadId], references: [id])
  parent     OKR?            @relation("OKRPadreHijo", fields: [parentId], references: [id])
  hijos      OKR[]           @relation("OKRPadreHijo")
  keyResults KeyResult[]

  @@index([periodoId, tipo])
  @@index([unidadId])
  @@map("okrs")
}

model KeyResult {
  id          String    @id @default(uuid()) @db.Uuid
  okrId       String    @map("okr_id") @db.Uuid
  codigo      String    @db.VarChar(20)
  titulo      String    @db.VarChar(300)
  tipo        String    @db.VarChar(50)
  unidadMedida String   @map("unidad_medida") @db.VarChar(50)
  lineaBase   Decimal   @map("linea_base") @db.Decimal(18, 2)
  meta        Decimal   @db.Decimal(18, 2)
  actual      Decimal   @default(0) @db.Decimal(18, 2)
  progreso    Decimal   @default(0) @db.Decimal(5, 2)
  estado      EstadoKR  @default(EN_TRACK)
  confianza   Decimal   @default(0.5) @db.Decimal(3, 2)
  ownerId     String    @map("owner_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  okr      OKR         @relation(fields: [okrId], references: [id])
  checkIns CheckInOKR[]

  @@unique([okrId, codigo])
  @@map("key_results")
}

model CheckInOKR {
  id           String   @id @default(uuid()) @db.Uuid
  keyResultId  String   @map("key_result_id") @db.Uuid
  fecha        DateTime @db.Date
  valorAnterior Decimal @map("valor_anterior") @db.Decimal(18, 2)
  valorNuevo   Decimal  @map("valor_nuevo") @db.Decimal(18, 2)
  confianza    Decimal  @db.Decimal(3, 2)
  bloqueadores String?  @db.Text
  acciones     String?  @db.Text
  registradoPor String  @map("registrado_por") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  keyResult KeyResult @relation(fields: [keyResultId], references: [id])

  @@index([keyResultId, fecha])
  @@map("checkins_okr")
}

model AlertaGestion {
  id              String          @id @default(uuid()) @db.Uuid
  tipo            String          @db.VarChar(50)
  origen          String          @db.VarChar(50)
  origenId        String?         @map("origen_id") @db.Uuid
  severidad       SeveridadAlerta
  titulo          String          @db.VarChar(200)
  descripcion     String          @db.Text
  condicion       String?         @db.Text
  valorActual     String?         @map("valor_actual") @db.VarChar(100)
  umbral          String?         @db.VarChar(100)
  fechaGeneracion DateTime        @map("fecha_generacion")
  fechaVencimiento DateTime?      @map("fecha_vencimiento")
  estado          EstadoAlerta    @default(ACTIVA)
  asignadoA       String?         @map("asignado_a") @db.Uuid
  fechaAtencion   DateTime?       @map("fecha_atencion")
  accionTomada    String?         @map("accion_tomada") @db.Text
  playbookId      String?         @map("playbook_id") @db.Uuid
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@index([tipo, estado])
  @@index([severidad, estado])
  @@index([asignadoA, estado])
  @@map("alertas_gestion")
}

// ═══════════════════════════════════════════════════════════════════════════════
// FIN SCHEMA
// ═══════════════════════════════════════════════════════════════════════════════
