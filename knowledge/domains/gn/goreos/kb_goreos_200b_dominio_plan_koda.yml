# GOS-200b: GORE_OS - Modelo de Datos: Dominio Planificación (D-PLAN)
# ═══════════════════════════════════════════════════════════════════════════════

Manifest:
  URN: "urn:knowledge:gorenuble:goreos:200b:modelo_datos:d_plan"
  Version: "1.0.0"
  Status: Draft

Metadata:
  Title: "GORE_OS - Modelo de Datos: D-PLAN (Planificación)"
  Description: "Detalle de las 7 entidades del dominio Planificación"
  Domain: GORE_OS
  Created: "2024-12-14"
  Ref: "kb_goreos_200_modelo_datos_esqueleto_koda.yml"
  Tags: [goreos, modelo_datos, d_plan, erd, prot]

# ═══════════════════════════════════════════════════════════════════════════════
# ERD - Estrategia Regional de Desarrollo
# ═══════════════════════════════════════════════════════════════════════════════

ERD:
  _meta:
    dominio: D-PLAN
    tabla: erds
    descripcion: "Estrategia Regional de Desarrollo"
  
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(30), unique: true, not_null: true }
    nombre: { tipo: String(255), not_null: true }
    periodo_inicio: { tipo: Integer, not_null: true }
    periodo_fin: { tipo: Integer, not_null: true }
    vision: { tipo: Text, not_null: true }
    mision: { tipo: Text, nullable: true }
    valores: { tipo: JSONB, nullable: true }
    diagnostico_resumen: { tipo: Text, nullable: true }
    diagnostico_url: { tipo: String(500), nullable: true }
    documento_url: { tipo: String(500), nullable: true }
    resolucion_aprobacion: { tipo: String(50), nullable: true }
    fecha_aprobacion: { tipo: Date, nullable: true }
    estado:
      tipo: Enum
      valores: [ELABORACION, CONSULTA, APROBADA, VIGENTE, HISTORICA]
      not_null: true
      default: ELABORACION
    version: { tipo: String(10), default: "1.0" }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [estado], tipo: btree }
    - { campos: [periodo_inicio, periodo_fin], tipo: btree }
  
  relaciones:
    ejes: { tipo: "1:N", entidad: EjeTematico, fk: "ejes_tematicos.erd_id" }
    objetivos: { tipo: "1:N", entidad: ObjetivoEstrategico, fk: "objetivos_estrategicos.erd_id" }
    iniciativas: { tipo: "1:N", entidad: Iniciativa, fk: "iniciativas.erd_id" }
  
  reglas:
    - id: RN-ERD-01
      regla: "Solo una ERD puede estar VIGENTE a la vez"
    - id: RN-ERD-02
      regla: "periodo_fin debe ser > periodo_inicio"
    - id: RN-ERD-03
      regla: "Debe tener al menos un objetivo estratégico antes de aprobar"
    - id: RN-ERD-04
      regla: "Al cambiar a VIGENTE, la anterior pasa a HISTORICA"

# ═══════════════════════════════════════════════════════════════════════════════
# EJE TEMÁTICO
# ═══════════════════════════════════════════════════════════════════════════════

EjeTematico:
  _meta:
    dominio: D-PLAN
    tabla: ejes_tematicos
    descripcion: "Eje temático o área de desarrollo de la ERD"
  
  atributos:
    id: { tipo: UUID, pk: true }
    erd_id: { tipo: "FK(erds.id)", not_null: true }
    codigo: { tipo: String(10), not_null: true }
    nombre: { tipo: String(200), not_null: true }
    descripcion: { tipo: Text, nullable: true }
    imagen_url: { tipo: String(500), nullable: true }
    color: { tipo: String(7), nullable: true, descripcion: "#RRGGBB" }
    icono: { tipo: String(50), nullable: true }
    orden: { tipo: Integer, default: 0 }
    created_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [erd_id, codigo], tipo: unique }
    - { campos: [erd_id, orden], tipo: btree }
  
  relaciones:
    erd: { tipo: "N:1", entidad: ERD, fk: "ejes_tematicos.erd_id" }
    objetivos: { tipo: "1:N", entidad: ObjetivoEstrategico, fk: "objetivos_estrategicos.eje_id" }

# ═══════════════════════════════════════════════════════════════════════════════
# OBJETIVO ESTRATÉGICO
# ═══════════════════════════════════════════════════════════════════════════════

ObjetivoEstrategico:
  _meta:
    dominio: D-PLAN
    tabla: objetivos_estrategicos
    descripcion: "Objetivo de alto nivel de la ERD"
  
  atributos:
    id: { tipo: UUID, pk: true }
    erd_id: { tipo: "FK(erds.id)", not_null: true }
    eje_id: { tipo: "FK(ejes_tematicos.id)", nullable: true }
    parent_id: { tipo: "FK(objetivos_estrategicos.id)", nullable: true }
    codigo: { tipo: String(20), not_null: true }
    nombre: { tipo: String(500), not_null: true }
    descripcion: { tipo: Text, nullable: true }
    tipo:
      tipo: Enum
      valores: [ESTRATEGICO, ESPECIFICO]
      not_null: true
      default: ESTRATEGICO
    indicador_resultado: { tipo: String(255), nullable: true }
    linea_base: { tipo: Decimal(18,2), nullable: true }
    meta: { tipo: Decimal(18,2), nullable: true }
    anio_meta: { tipo: Integer, nullable: true }
    unidad_medida: { tipo: String(50), nullable: true }
    fuente_verificacion: { tipo: String(255), nullable: true }
    orden: { tipo: Integer, default: 0 }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [erd_id, codigo], tipo: unique }
    - { campos: [eje_id], tipo: btree }
    - { campos: [parent_id], tipo: btree }
    - { campos: [tipo], tipo: btree }
  
  relaciones:
    erd: { tipo: "N:1", entidad: ERD, fk: "objetivos_estrategicos.erd_id" }
    eje: { tipo: "N:1", entidad: EjeTematico, fk: "objetivos_estrategicos.eje_id" }
    padre: { tipo: "N:1", entidad: ObjetivoEstrategico, fk: "objetivos_estrategicos.parent_id" }
    hijos: { tipo: "1:N", entidad: ObjetivoEstrategico, fk: "objetivos_estrategicos.parent_id" }
    lineamientos: { tipo: "1:N", entidad: Lineamiento, fk: "lineamientos.objetivo_id" }
    iniciativas: { tipo: "1:N", entidad: Iniciativa, fk: "iniciativas.objetivo_erd_id" }
    indicadores: { tipo: "1:N", entidad: IndicadorRegional, fk: "indicadores_regionales.objetivo_erd_id" }
  
  reglas:
    - id: RN-OBJ-01
      regla: "Objetivo ESPECIFICO debe tener parent_id (objetivo padre)"
    - id: RN-OBJ-02
      regla: "Objetivo ESTRATEGICO no tiene parent_id"
    - id: RN-OBJ-03
      regla: "Si tiene meta, debe tener anio_meta"

# ═══════════════════════════════════════════════════════════════════════════════
# LINEAMIENTO
# ═══════════════════════════════════════════════════════════════════════════════

Lineamiento:
  _meta:
    dominio: D-PLAN
    tabla: lineamientos
    descripcion: "Directriz para alcanzar un objetivo estratégico"
  
  atributos:
    id: { tipo: UUID, pk: true }
    objetivo_id: { tipo: "FK(objetivos_estrategicos.id)", not_null: true }
    codigo: { tipo: String(20), not_null: true }
    descripcion: { tipo: Text, not_null: true }
    tipo:
      tipo: Enum
      valores: [POLITICA, INVERSION, GESTION, NORMATIVO, COORDINACION]
      not_null: true
    orden: { tipo: Integer, default: 0 }
    created_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [objetivo_id, codigo], tipo: unique }
  
  relaciones:
    objetivo: { tipo: "N:1", entidad: ObjetivoEstrategico, fk: "lineamientos.objetivo_id" }

# ═══════════════════════════════════════════════════════════════════════════════
# PROT - Plan Regional de Ordenamiento Territorial
# ═══════════════════════════════════════════════════════════════════════════════

PROT:
  _meta:
    dominio: D-PLAN
    tabla: prots
    descripcion: "Plan Regional de Ordenamiento Territorial"
  
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(30), unique: true, not_null: true }
    nombre: { tipo: String(255), not_null: true }
    descripcion: { tipo: Text, nullable: true }
    fecha_inicio_elaboracion: { tipo: Date, nullable: true }
    fecha_consulta_publica_inicio: { tipo: Date, nullable: true }
    fecha_consulta_publica_fin: { tipo: Date, nullable: true }
    fecha_aprobacion: { tipo: Date, nullable: true }
    resolucion_aprobacion: { tipo: String(50), nullable: true }
    estado:
      tipo: Enum
      valores: [ELABORACION, CONSULTA, APROBADO, VIGENTE, MODIFICACION, HISTORICO]
      not_null: true
      default: ELABORACION
    documento_url: { tipo: String(500), nullable: true }
    memoria_url: { tipo: String(500), nullable: true }
    cartografia_url: { tipo: String(500), nullable: true }
    version: { tipo: String(10), default: "1.0" }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [estado], tipo: btree }
  
  relaciones:
    zonificaciones: { tipo: "1:N", entidad: Zonificacion, fk: "zonificaciones.prot_id" }
    normativas: { tipo: "1:N", entidad: NormativaPROT, fk: "normativas_prot.prot_id" }
  
  reglas:
    - id: RN-PROT-01
      regla: "Solo un PROT puede estar VIGENTE a la vez"
    - id: RN-PROT-02
      regla: "Al cambiar a VIGENTE, el anterior pasa a HISTORICO"

# ═══════════════════════════════════════════════════════════════════════════════
# ZONIFICACIÓN
# ═══════════════════════════════════════════════════════════════════════════════

Zonificacion:
  _meta:
    dominio: D-PLAN
    tabla: zonificaciones
    descripcion: "Zona definida en el PROT"
  
  atributos:
    id: { tipo: UUID, pk: true }
    prot_id: { tipo: "FK(prots.id)", not_null: true }
    codigo: { tipo: String(30), not_null: true }
    nombre: { tipo: String(200), not_null: true }
    descripcion: { tipo: Text, nullable: true }
    tipo:
      tipo: Enum
      valores: [URBANA, EXTENSION_URBANA, RURAL, PROTECCION, RIESGO, PRODUCTIVA, INFRAESTRUCTURA, MIXTA]
      not_null: true
    subtipo: { tipo: String(100), nullable: true }
    geometria: { tipo: "Geometry(MultiPolygon, 4326)", not_null: true }
    superficie_ha: { tipo: Decimal(12,2), nullable: true }
    usos_permitidos: { tipo: JSONB, nullable: true }
    usos_condicionados: { tipo: JSONB, nullable: true }
    usos_prohibidos: { tipo: JSONB, nullable: true }
    condiciones_especiales: { tipo: Text, nullable: true }
    normas_aplicables: { tipo: JSONB, nullable: true }
    color: { tipo: String(7), nullable: true }
    orden_capa: { tipo: Integer, default: 0 }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [prot_id, codigo], tipo: unique }
    - { campos: [tipo], tipo: btree }
    - { campos: [geometria], tipo: gist }
  
  relaciones:
    prot: { tipo: "N:1", entidad: PROT, fk: "zonificaciones.prot_id" }
  
  reglas:
    - id: RN-ZON-01
      regla: "superficie_ha se calcula automáticamente de geometria"
    - id: RN-ZON-02
      regla: "Geometría no debe superponerse con otras zonas del mismo PROT"

# ═══════════════════════════════════════════════════════════════════════════════
# CONVENIO DE PROGRAMACIÓN
# ═══════════════════════════════════════════════════════════════════════════════

ConvenioProgramacion:
  _meta:
    dominio: D-PLAN
    tabla: convenios_programacion
    descripcion: "Acuerdo plurianual GORE-Ministerio"
  
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(30), unique: true, not_null: true }
    nombre: { tipo: String(255), not_null: true }
    descripcion: { tipo: Text, nullable: true }
    ministerio: { tipo: String(200), not_null: true }
    servicio: { tipo: String(200), nullable: true }
    objetivo_general: { tipo: Text, nullable: true }
    monto_total: { tipo: Decimal(18,0), not_null: true }
    aporte_gore: { tipo: Decimal(18,0), not_null: true }
    aporte_sectorial: { tipo: Decimal(18,0), not_null: true }
    aporte_otro: { tipo: Decimal(18,0), default: 0 }
    fecha_suscripcion: { tipo: Date, nullable: true }
    fecha_inicio: { tipo: Date, not_null: true }
    fecha_termino: { tipo: Date, not_null: true }
    resolucion_gore: { tipo: String(50), nullable: true }
    resolucion_ministerial: { tipo: String(50), nullable: true }
    estado:
      tipo: Enum
      valores: [NEGOCIACION, FORMULACION, REVISION, SUSCRITO, EN_EJECUCION, MODIFICACION, CERRADO]
      not_null: true
      default: NEGOCIACION
    objetivo_erd_id: { tipo: "FK(objetivos_estrategicos.id)", nullable: true }
    documento_url: { tipo: String(500), nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [estado], tipo: btree }
    - { campos: [ministerio], tipo: btree }
    - { campos: [fecha_inicio, fecha_termino], tipo: btree }
  
  relaciones:
    objetivo_erd: { tipo: "N:1", entidad: ObjetivoEstrategico, fk: "convenios_programacion.objetivo_erd_id" }
    iniciativas: { tipo: "1:N", entidad: Iniciativa, fk: "iniciativas.convenio_programacion_id" }
    programaciones: { tipo: "1:N", entidad: ProgramacionAnualCP, fk: "programaciones_anuales_cp.convenio_programacion_id" }
  
  reglas:
    - id: RN-CP-01
      regla: "monto_total = aporte_gore + aporte_sectorial + aporte_otro"
    - id: RN-CP-02
      regla: "fecha_termino debe ser > fecha_inicio"
    - id: RN-CP-03
      regla: "Suma de iniciativas no puede exceder monto_total"

# ═══════════════════════════════════════════════════════════════════════════════
# PROGRAMACIÓN ANUAL CP
# ═══════════════════════════════════════════════════════════════════════════════

ProgramacionAnualCP:
  _meta:
    dominio: D-PLAN
    tabla: programaciones_anuales_cp
    descripcion: "Programación anual de un convenio de programación"
  
  atributos:
    id: { tipo: UUID, pk: true }
    convenio_programacion_id: { tipo: "FK(convenios_programacion.id)", not_null: true }
    anio: { tipo: Integer, not_null: true }
    monto_programado_gore: { tipo: Decimal(18,0), not_null: true }
    monto_programado_sectorial: { tipo: Decimal(18,0), not_null: true }
    monto_ejecutado_gore: { tipo: Decimal(18,0), default: 0 }
    monto_ejecutado_sectorial: { tipo: Decimal(18,0), default: 0 }
    estado:
      tipo: Enum
      valores: [PROGRAMADO, EN_EJECUCION, EJECUTADO, REPROGRAMADO]
      default: PROGRAMADO
    observaciones: { tipo: Text, nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [convenio_programacion_id, anio], tipo: unique }
  
  relaciones:
    convenio: { tipo: "N:1", entidad: ConvenioProgramacion, fk: "programaciones_anuales_cp.convenio_programacion_id" }

# ═══════════════════════════════════════════════════════════════════════════════
# FIN D-PLAN
# ═══════════════════════════════════════════════════════════════════════════════
