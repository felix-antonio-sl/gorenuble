# GOS-200g: GORE_OS - Modelo de Datos: Dominios Territorio y Gestión
# ═══════════════════════════════════════════════════════════════════════════════

Manifest:
  URN: "urn:knowledge:gorenuble:goreos:200g:modelo_datos:d_terr_gestion"
  Version: "1.0.0"
  Status: Draft

Metadata:
  Title: "GORE_OS - Modelo de Datos: D-TERR + D-GESTION"
  Description: "Detalle de entidades de Territorio (3) y Gestión Institucional (9)"
  Domain: GORE_OS
  Created: "2024-12-14"
  Tags: [goreos, modelo_datos, d_terr, d_gestion, okr, indicador]

# ═══════════════════════════════════════════════════════════════════════════════
# D-TERR: TERRITORIO
# ═══════════════════════════════════════════════════════════════════════════════

CapaGeografica:
  _meta:
    dominio: D-TERR
    tabla: capas_geograficas
    descripcion: "Capa de información geográfica del IDE regional"
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(50), unique: true }
    nombre: { tipo: String(200) }
    descripcion: { tipo: Text, nullable: true }
    categoria: { tipo: "Enum[BASE,PLANIFICACION,INFRAESTRUCTURA,AMBIENTAL,SOCIAL,ECONOMICA,RIESGO]" }
    tipo_geometria: { tipo: "Enum[POINT,LINESTRING,POLYGON,MULTIPOINT,MULTILINESTRING,MULTIPOLYGON]" }
    fuente: { tipo: String(200) }
    fecha_actualizacion: { tipo: Date }
    escala: { tipo: String(20), nullable: true }
    sistema_referencia: { tipo: String(20), default: "EPSG:4326" }
    url_servicio_wms: { tipo: String(500), nullable: true }
    url_servicio_wfs: { tipo: String(500), nullable: true }
    metadatos: { tipo: JSONB, nullable: true }
    publica: { tipo: Boolean, default: false }
    activa: { tipo: Boolean, default: true }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [categoria, activa], tipo: btree }

IndicadorComunal:
  _meta:
    dominio: D-TERR
    tabla: indicadores_comunales
    descripcion: "Indicador a nivel comunal"
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(50), unique: true }
    nombre: { tipo: String(300) }
    descripcion: { tipo: Text, nullable: true }
    dimension: { tipo: "Enum[DEMOGRAFIA,ECONOMIA,EDUCACION,SALUD,VIVIENDA,SEGURIDAD,AMBIENTE,CONECTIVIDAD]" }
    fuente: { tipo: String(200) }
    unidad: { tipo: String(50) }
    metodologia: { tipo: Text, nullable: true }
    periodicidad: { tipo: "Enum[ANUAL,CENSAL,ENCUESTA]" }
    ultima_actualizacion: { tipo: Date, nullable: true }
    activo: { tipo: Boolean, default: true }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [dimension], tipo: btree }
  relaciones:
    series: { tipo: "1:N", entidad: SerieTemporal }

SerieTemporal:
  _meta:
    dominio: D-TERR
    tabla: series_temporales
    descripcion: "Serie de valores de indicador comunal"
  atributos:
    id: { tipo: UUID, pk: true }
    indicador_id: { tipo: "FK(indicadores_comunales.id)" }
    territorio_id: { tipo: "FK(territorios.id)" }
    anio: { tipo: Integer }
    valor: { tipo: Decimal(18,4) }
    valor_regional: { tipo: Decimal(18,4), nullable: true }
    valor_nacional: { tipo: Decimal(18,4), nullable: true }
    ranking_regional: { tipo: Integer, nullable: true }
    fuente_especifica: { tipo: String(200), nullable: true }
    observaciones: { tipo: Text, nullable: true }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [indicador_id, territorio_id, anio], tipo: unique }
  relaciones:
    indicador: { tipo: "N:1", entidad: IndicadorComunal }
    territorio: { tipo: "N:1", entidad: Territorio }

# ═══════════════════════════════════════════════════════════════════════════════
# D-GESTION: GESTIÓN INSTITUCIONAL
# ═══════════════════════════════════════════════════════════════════════════════

OKR:
  _meta:
    dominio: D-GESTION
    tabla: okrs
    descripcion: "Objetivo y Resultados Clave"
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(30), unique: true }
    periodo_id: { tipo: "FK(periodos.id)" }
    tipo: { tipo: "Enum[ORGANIZACIONAL,DIVISION,UNIDAD]" }
    unidad_id: { tipo: "FK(unidades_organicas.id)", nullable: true }
    objetivo: { tipo: Text }
    descripcion: { tipo: Text, nullable: true }
    parent_id: { tipo: "FK(okrs.id)", nullable: true, descripcion: "OKR padre (cascada)" }
    owner_id: { tipo: "FK(funcionarios.id)" }
    estado: { tipo: "Enum[BORRADOR,ACTIVO,CERRADO,CANCELADO]", default: BORRADOR }
    progreso: { tipo: Decimal(5,2), default: 0 }
    confianza_promedio: { tipo: Decimal(3,2), default: 0.5 }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [periodo_id, tipo], tipo: btree }
    - { campos: [unidad_id], tipo: btree }
  relaciones:
    periodo: { tipo: "N:1", entidad: Periodo }
    unidad: { tipo: "N:1", entidad: UnidadOrganica }
    owner: { tipo: "N:1", entidad: Funcionario }
    key_results: { tipo: "1:N", entidad: KeyResult }
  reglas:
    - id: RN-OKR-01
      regla: "OKR ORGANIZACIONAL no tiene unidad_id ni parent_id"
    - id: RN-OKR-02
      regla: "progreso se calcula como promedio de key_results"

KeyResult:
  _meta:
    dominio: D-GESTION
    tabla: key_results
    descripcion: "Resultado Clave de un OKR"
  atributos:
    id: { tipo: UUID, pk: true }
    okr_id: { tipo: "FK(okrs.id)" }
    numero: { tipo: Integer }
    descripcion: { tipo: String(500) }
    metrica: { tipo: String(200) }
    tipo_metrica: { tipo: "Enum[NUMERO,PORCENTAJE,BINARIO,HITO]" }
    linea_base: { tipo: Decimal(18,2), default: 0 }
    meta: { tipo: Decimal(18,2) }
    actual: { tipo: Decimal(18,2), default: 0 }
    progreso: { tipo: Decimal(5,2), default: 0 }
    confianza: { tipo: Decimal(3,2), default: 0.5, descripcion: "0-1" }
    estado: { tipo: "Enum[EN_RIESGO,EN_TRACK,LOGRADO,NO_LOGRADO]", default: EN_TRACK }
    responsable_id: { tipo: "FK(funcionarios.id)", nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [okr_id, numero], tipo: unique }
  relaciones:
    okr: { tipo: "N:1", entidad: OKR }
    checkins: { tipo: "1:N", entidad: CheckInOKR }
  reglas:
    - id: RN-KR-01
      regla: "progreso = (actual - linea_base) / (meta - linea_base) * 100"

CheckInOKR:
  _meta:
    dominio: D-GESTION
    tabla: checkins_okr
    descripcion: "Actualización periódica de Key Result"
  atributos:
    id: { tipo: UUID, pk: true }
    key_result_id: { tipo: "FK(key_results.id)" }
    fecha: { tipo: Date }
    valor_reportado: { tipo: Decimal(18,2) }
    confianza: { tipo: Decimal(3,2) }
    comentario: { tipo: Text, nullable: true }
    bloqueadores: { tipo: Text, nullable: true }
    acciones_proximas: { tipo: Text, nullable: true }
    reportado_por: { tipo: "FK(usuarios.id)" }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [key_result_id, fecha], tipo: unique }

IndicadorGestion:
  _meta:
    dominio: D-GESTION
    tabla: indicadores_gestion
    descripcion: "Indicador operacional del GORE"
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(30), unique: true }
    nombre: { tipo: String(200) }
    descripcion: { tipo: Text, nullable: true }
    dominio: { tipo: "Enum[D_PLAN,D_FIN,D_EJEC,D_COORD,D_NORM,D_BACK,D_TDE,D_TERR,GOB]" }
    formula: { tipo: Text }
    unidad: { tipo: String(50) }
    polaridad: { tipo: "Enum[MAYOR_MEJOR,MENOR_MEJOR]", default: MAYOR_MEJOR }
    frecuencia: { tipo: "Enum[DIARIA,SEMANAL,MENSUAL,TRIMESTRAL]" }
    meta_anual: { tipo: Decimal(18,2), nullable: true }
    umbral_critico: { tipo: Decimal(18,2), descripcion: "Valor que dispara alerta CRITICA" }
    umbral_alerta: { tipo: Decimal(18,2), descripcion: "Valor que dispara alerta WARNING" }
    peso_h_gore: { tipo: Decimal(5,2), default: 1, descripcion: "Peso en cálculo H_gore" }
    automatizado: { tipo: Boolean, default: false }
    query_automatizacion: { tipo: Text, nullable: true }
    activo: { tipo: Boolean, default: true }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [dominio, activo], tipo: btree }
  relaciones:
    mediciones: { tipo: "1:N", entidad: MedicionIndicador }

MedicionIndicador:
  _meta:
    dominio: D-GESTION
    tabla: mediciones_indicador
  atributos:
    id: { tipo: UUID, pk: true }
    indicador_id: { tipo: "FK(indicadores_gestion.id)" }
    periodo_id: { tipo: "FK(periodos.id)" }
    valor: { tipo: Decimal(18,4) }
    valor_anterior: { tipo: Decimal(18,4), nullable: true }
    estado: { tipo: "Enum[CRITICO,ALERTA,ACEPTABLE,SALUDABLE]" }
    tendencia: { tipo: "Enum[MEJORANDO,ESTABLE,EMPEORANDO]" }
    fecha_medicion: { tipo: DateTime }
    fuente: { tipo: String(200), nullable: true }
    automatica: { tipo: Boolean, default: false }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [indicador_id, periodo_id], tipo: unique }

SnapshotHGore:
  _meta:
    dominio: D-GESTION
    tabla: snapshots_h_gore
    descripcion: "Instantánea de salud institucional"
  atributos:
    id: { tipo: UUID, pk: true }
    fecha: { tipo: Date, unique: true }
    periodo_id: { tipo: "FK(periodos.id)", nullable: true }
    h_gore: { tipo: Decimal(5,2), descripcion: "Índice agregado 0-100" }
    d_plan_score: { tipo: Decimal(5,2) }
    d_fin_score: { tipo: Decimal(5,2) }
    d_ejec_score: { tipo: Decimal(5,2) }
    d_coord_score: { tipo: Decimal(5,2) }
    d_norm_score: { tipo: Decimal(5,2) }
    d_back_score: { tipo: Decimal(5,2) }
    d_tde_score: { tipo: Decimal(5,2) }
    gob_score: { tipo: Decimal(5,2) }
    estado: { tipo: "Enum[CRITICO,ALERTA,ACEPTABLE,SALUDABLE]" }
    tendencia: { tipo: "Enum[MEJORANDO,ESTABLE,EMPEORANDO]" }
    alertas_activas: { tipo: Integer, default: 0 }
    playbooks_activos: { tipo: Integer, default: 0 }
    detalle: { tipo: JSONB, nullable: true }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [fecha], tipo: unique }
  reglas:
    - id: RN-HG-01
      regla: "h_gore = promedio ponderado de scores por dominio"
    - id: RN-HG-02
      regla: "estado se determina: <40=CRITICO, <60=ALERTA, <80=ACEPTABLE, >=80=SALUDABLE"

AlertaGestion:
  _meta:
    dominio: D-GESTION
    tabla: alertas_gestion
    descripcion: "Alerta del sistema de monitoreo"
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(30) }
    fecha_generacion: { tipo: DateTime }
    tipo: { tipo: "Enum[H_GORE,INDICADOR,VENCIMIENTO,SLA,ANOMALIA,COMPROMISO]" }
    severidad: { tipo: "Enum[INFO,WARNING,CRITICAL]" }
    dominio: { tipo: String(20) }
    entidad_tipo: { tipo: String(50), nullable: true }
    entidad_id: { tipo: UUID, nullable: true }
    titulo: { tipo: String(300) }
    descripcion: { tipo: Text }
    valor_actual: { tipo: String(100), nullable: true }
    valor_umbral: { tipo: String(100), nullable: true }
    estado: { tipo: "Enum[ACTIVA,EN_ATENCION,RESUELTA,ESCALADA,IGNORADA]", default: ACTIVA }
    asignado_a_id: { tipo: "FK(usuarios.id)", nullable: true }
    fecha_asignacion: { tipo: DateTime, nullable: true }
    fecha_resolucion: { tipo: DateTime, nullable: true }
    playbook_sugerido: { tipo: String(50), nullable: true }
    accion_tomada: { tipo: Text, nullable: true }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [estado, severidad], tipo: btree }
    - { campos: [dominio], tipo: btree }
    - { campos: [fecha_generacion], tipo: btree }

Playbook:
  _meta:
    dominio: D-GESTION
    tabla: playbooks
    descripcion: "Procedimiento de respuesta estructurado"
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(20), unique: true }
    nombre: { tipo: String(200) }
    descripcion: { tipo: Text }
    tipo: { tipo: "Enum[RECOVERY,OPTIMIZATION,ACCELERATION]" }
    dominio: { tipo: String(20), nullable: true }
    trigger_condicion: { tipo: Text }
    duracion_estimada: { tipo: String(50) }
    version: { tipo: String(10), default: "1.0" }
    activo: { tipo: Boolean, default: true }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [codigo], tipo: unique }
  relaciones:
    pasos: { tipo: "1:N", entidad: PasoPlaybook }
    ejecuciones: { tipo: "1:N", entidad: EjecucionPlaybook }

PasoPlaybook:
  _meta:
    dominio: D-GESTION
    tabla: pasos_playbook
  atributos:
    id: { tipo: UUID, pk: true }
    playbook_id: { tipo: "FK(playbooks.id)" }
    numero: { tipo: Integer }
    nombre: { tipo: String(200) }
    descripcion: { tipo: Text }
    responsable_rol: { tipo: String(100), nullable: true }
    duracion_estimada: { tipo: String(50), nullable: true }
    criterio_exito: { tipo: Text, nullable: true }
    created_at: { tipo: DateTime, auto: true }
  indices:
    - { campos: [playbook_id, numero], tipo: unique }

EjecucionPlaybook:
  _meta:
    dominio: D-GESTION
    tabla: ejecuciones_playbook
  atributos:
    id: { tipo: UUID, pk: true }
    playbook_id: { tipo: "FK(playbooks.id)" }
    alerta_id: { tipo: "FK(alertas_gestion.id)", nullable: true }
    fecha_inicio: { tipo: DateTime }
    fecha_fin: { tipo: DateTime, nullable: true }
    estado: { tipo: "Enum[EN_CURSO,COMPLETADO,ABORTADO,FALLIDO]", default: EN_CURSO }
    paso_actual: { tipo: Integer, default: 1 }
    ejecutado_por_id: { tipo: "FK(usuarios.id)" }
    resultado: { tipo: Text, nullable: true }
    metricas_antes: { tipo: JSONB, nullable: true }
    metricas_despues: { tipo: JSONB, nullable: true }
    created_at: { tipo: DateTime, auto: true }

# ═══════════════════════════════════════════════════════════════════════════════
# FIN D-TERR + D-GESTION
# ═══════════════════════════════════════════════════════════════════════════════
