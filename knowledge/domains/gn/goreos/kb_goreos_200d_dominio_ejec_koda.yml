# GOS-200d: GORE_OS - Modelo de Datos: Dominio Ejecución (D-EJEC)
# ═══════════════════════════════════════════════════════════════════════════════

Manifest:
  URN: "urn:knowledge:gorenuble:goreos:200d:modelo_datos:d_ejec"
  Version: "1.0.0"
  Status: Draft

Metadata:
  Title: "GORE_OS - Modelo de Datos: D-EJEC (Ejecución)"
  Description: "Detalle de las 7 entidades del dominio Ejecución"
  Domain: GORE_OS
  Created: "2024-12-14"
  Ref: "kb_goreos_200_modelo_datos_esqueleto_koda.yml"
  Tags: [goreos, modelo_datos, d_ejec, convenio, rendicion]

# ═══════════════════════════════════════════════════════════════════════════════
# CONVENIO
# ═══════════════════════════════════════════════════════════════════════════════

Convenio:
  _meta:
    dominio: D-EJEC
    tabla: convenios
    descripcion: "Convenio de transferencia de recursos"
  
  atributos:
    id: { tipo: UUID, pk: true }
    numero: { tipo: String(30), unique: true, not_null: true }
    iniciativa_id: { tipo: "FK(iniciativas.id)", not_null: true }
    unidad_ejecutora_id: { tipo: "FK(actores.id)", not_null: true }
    tipo:
      tipo: Enum
      valores: [MANDATO, TRANSFERENCIA, COLABORACION, MARCO, ESPECIFICO]
      not_null: true
    objeto: { tipo: Text, not_null: true }
    descripcion: { tipo: Text, nullable: true }
    monto_total: { tipo: Decimal(18,0), not_null: true }
    aporte_gore: { tipo: Decimal(18,0), not_null: true }
    aporte_ejecutor: { tipo: Decimal(18,0), default: 0 }
    aporte_terceros: { tipo: Decimal(18,0), default: 0 }
    fecha_suscripcion: { tipo: Date, nullable: true }
    fecha_inicio: { tipo: Date, not_null: true }
    fecha_termino_original: { tipo: Date, not_null: true }
    fecha_termino_vigente: { tipo: Date, not_null: true }
    plazo_meses: { tipo: Integer, not_null: true }
    estado:
      tipo: Enum
      valores: [BORRADOR, EN_REVISION_JURIDICA, EN_REVISION_TECNICA, PARA_FIRMA, VIGENTE, EN_MODIFICACION, EN_LIQUIDACION, LIQUIDADO, CADUCADO, RESCILIADO]
      not_null: true
      default: BORRADOR
    resolucion_aprobatoria: { tipo: String(50), nullable: true }
    fecha_resolucion: { tipo: Date, nullable: true }
    # Control financiero
    monto_transferido: { tipo: Decimal(18,0), default: 0 }
    monto_rendido: { tipo: Decimal(18,0), default: 0 }
    monto_aprobado: { tipo: Decimal(18,0), default: 0 }
    monto_observado: { tipo: Decimal(18,0), default: 0 }
    saldo_por_rendir: { tipo: Decimal(18,0), default: 0 }
    # Control ejecución
    avance_fisico: { tipo: Decimal(5,2), default: 0 }
    avance_financiero: { tipo: Decimal(5,2), default: 0 }
    semaforo:
      tipo: Enum
      valores: [VERDE, AMARILLO, ROJO, GRIS]
      default: GRIS
    # Supervisión
    supervisor_id: { tipo: "FK(funcionarios.id)", nullable: true }
    analista_rendicion_id: { tipo: "FK(funcionarios.id)", nullable: true }
    # Documentación
    documento_url: { tipo: String(500), nullable: true }
    expediente_id: { tipo: "FK(expedientes_electronicos.id)", nullable: true }
    # Auditoría
    created_by: { tipo: "FK(usuarios.id)", nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_by: { tipo: "FK(usuarios.id)", nullable: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [numero], tipo: unique }
    - { campos: [iniciativa_id], tipo: btree }
    - { campos: [unidad_ejecutora_id], tipo: btree }
    - { campos: [estado], tipo: btree }
    - { campos: [semaforo], tipo: btree }
    - { campos: [fecha_termino_vigente], tipo: btree }
  
  relaciones:
    iniciativa: { tipo: "N:1", entidad: Iniciativa, fk: "convenios.iniciativa_id" }
    unidad_ejecutora: { tipo: "N:1", entidad: Actor, fk: "convenios.unidad_ejecutora_id" }
    supervisor: { tipo: "N:1", entidad: Funcionario, fk: "convenios.supervisor_id" }
    hitos: { tipo: "1:N", entidad: HitoConvenio, fk: "hitos_convenio.convenio_id" }
    desembolsos: { tipo: "1:N", entidad: Desembolso, fk: "desembolsos.convenio_id" }
    addendums: { tipo: "1:N", entidad: Addendum, fk: "addendums.convenio_id" }
    rendiciones: { tipo: "1:N", entidad: Rendicion, fk: "rendiciones.convenio_id" }
    proyecto_pmo: { tipo: "1:0..1", entidad: ProyectoPMO, fk: "proyectos_pmo.convenio_id" }
  
  reglas:
    - id: RN-CON-01
      regla: "monto_total = aporte_gore + aporte_ejecutor + aporte_terceros"
    - id: RN-CON-02
      regla: "fecha_termino >= fecha_inicio"
    - id: RN-CON-03
      regla: "saldo_por_rendir = monto_transferido - monto_aprobado"
    - id: RN-CON-04
      regla: "Actor debe tener es_unidad_ejecutora=true"
    - id: RN-CON-05
      regla: "No puede modificarse si estado=LIQUIDADO"

# ═══════════════════════════════════════════════════════════════════════════════
# HITO CONVENIO
# ═══════════════════════════════════════════════════════════════════════════════

HitoConvenio:
  _meta:
    dominio: D-EJEC
    tabla: hitos_convenio
    descripcion: "Hito de control del convenio"
  
  atributos:
    id: { tipo: UUID, pk: true }
    convenio_id: { tipo: "FK(convenios.id)", not_null: true }
    numero: { tipo: Integer, not_null: true }
    nombre: { tipo: String(200), not_null: true }
    descripcion: { tipo: Text, nullable: true }
    tipo:
      tipo: Enum
      valores: [ENTREGABLE, INFORME, VERIFICACION, PAGO, CIERRE]
      not_null: true
    fecha_programada: { tipo: Date, not_null: true }
    fecha_cumplimiento: { tipo: Date, nullable: true }
    monto_asociado: { tipo: Decimal(18,0), default: 0 }
    porcentaje_avance: { tipo: Decimal(5,2), default: 0 }
    estado:
      tipo: Enum
      valores: [PENDIENTE, EN_PROCESO, CUMPLIDO, ATRASADO, REPROGRAMADO, CANCELADO]
      not_null: true
      default: PENDIENTE
    evidencia_url: { tipo: String(500), nullable: true }
    observaciones: { tipo: Text, nullable: true }
    aprobado_por: { tipo: "FK(usuarios.id)", nullable: true }
    fecha_aprobacion: { tipo: DateTime, nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [convenio_id, numero], tipo: unique }
    - { campos: [estado], tipo: btree }
    - { campos: [fecha_programada], tipo: btree }
  
  relaciones:
    convenio: { tipo: "N:1", entidad: Convenio, fk: "hitos_convenio.convenio_id" }
    desembolso: { tipo: "1:0..1", entidad: Desembolso, fk: "desembolsos.hito_id" }
  
  reglas:
    - id: RN-HIT-01
      regla: "Si fecha_cumplimiento > fecha_programada, estado→ATRASADO"
    - id: RN-HIT-02
      regla: "Hito CUMPLIDO requiere evidencia_url o aprobación manual"

# ═══════════════════════════════════════════════════════════════════════════════
# DESEMBOLSO
# ═══════════════════════════════════════════════════════════════════════════════

Desembolso:
  _meta:
    dominio: D-EJEC
    tabla: desembolsos
    descripcion: "Transferencia de recursos al ejecutor"
  
  atributos:
    id: { tipo: UUID, pk: true }
    convenio_id: { tipo: "FK(convenios.id)", not_null: true }
    hito_id: { tipo: "FK(hitos_convenio.id)", nullable: true }
    numero_cuota: { tipo: Integer, not_null: true }
    descripcion: { tipo: String(255), nullable: true }
    monto: { tipo: Decimal(18,0), not_null: true }
    porcentaje_convenio: { tipo: Decimal(5,2), not_null: true }
    fecha_programada: { tipo: Date, not_null: true }
    fecha_solicitud: { tipo: Date, nullable: true }
    fecha_transferencia: { tipo: Date, nullable: true }
    estado:
      tipo: Enum
      valores: [PROGRAMADO, SOLICITADO, EN_PROCESO, TRANSFERIDO, ANULADO]
      not_null: true
      default: PROGRAMADO
    comprobante_transferencia: { tipo: String(100), nullable: true }
    numero_operacion: { tipo: String(50), nullable: true }
    observaciones: { tipo: Text, nullable: true }
    solicitado_por: { tipo: "FK(usuarios.id)", nullable: true }
    aprobado_por: { tipo: "FK(usuarios.id)", nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [convenio_id, numero_cuota], tipo: unique }
    - { campos: [estado], tipo: btree }
    - { campos: [fecha_programada], tipo: btree }
  
  relaciones:
    convenio: { tipo: "N:1", entidad: Convenio, fk: "desembolsos.convenio_id" }
    hito: { tipo: "N:0..1", entidad: HitoConvenio, fk: "desembolsos.hito_id" }
  
  reglas:
    - id: RN-DES-01
      regla: "Suma de desembolsos no puede exceder convenio.aporte_gore"
    - id: RN-DES-02
      regla: "Desembolso posterior requiere rendición anterior aprobada (según convenio)"
    - id: RN-DES-03
      regla: "Estado TRANSFERIDO requiere fecha_transferencia"

# ═══════════════════════════════════════════════════════════════════════════════
# ADDENDUM
# ═══════════════════════════════════════════════════════════════════════════════

Addendum:
  _meta:
    dominio: D-EJEC
    tabla: addendums
    descripcion: "Modificación a convenio vigente"
  
  atributos:
    id: { tipo: UUID, pk: true }
    convenio_id: { tipo: "FK(convenios.id)", not_null: true }
    numero: { tipo: Integer, not_null: true }
    tipo:
      tipo: Enum
      valores: [PRORROGA, AUMENTO_RECURSOS, DISMINUCION_RECURSOS, CAMBIO_ALCANCE, CAMBIO_EJECUTOR, OTRO]
      not_null: true
    motivo: { tipo: Text, not_null: true }
    descripcion_cambios: { tipo: Text, nullable: true }
    fecha_solicitud: { tipo: Date, nullable: true }
    fecha_suscripcion: { tipo: Date, nullable: true }
    resolucion: { tipo: String(50), nullable: true }
    # Cambios específicos
    nueva_fecha_termino: { tipo: Date, nullable: true }
    dias_prorroga: { tipo: Integer, nullable: true }
    monto_modificacion: { tipo: Decimal(18,0), nullable: true }
    nuevo_monto_total: { tipo: Decimal(18,0), nullable: true }
    nuevo_objeto: { tipo: Text, nullable: true }
    estado:
      tipo: Enum
      valores: [BORRADOR, EN_TRAMITE, APROBADO, RECHAZADO, ANULADO]
      not_null: true
      default: BORRADOR
    documento_url: { tipo: String(500), nullable: true }
    created_by: { tipo: "FK(usuarios.id)", nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [convenio_id, numero], tipo: unique }
    - { campos: [tipo], tipo: btree }
    - { campos: [estado], tipo: btree }
  
  relaciones:
    convenio: { tipo: "N:1", entidad: Convenio, fk: "addendums.convenio_id" }
  
  reglas:
    - id: RN-ADD-01
      regla: "Solo convenios VIGENTE o EN_MODIFICACION pueden tener addendum"
    - id: RN-ADD-02
      regla: "Al aprobar, actualiza campos correspondientes del convenio"
    - id: RN-ADD-03
      regla: "Prórrogas máximo 2 por convenio (salvo excepciones)"

# ═══════════════════════════════════════════════════════════════════════════════
# RENDICIÓN
# ═══════════════════════════════════════════════════════════════════════════════

Rendicion:
  _meta:
    dominio: D-EJEC
    tabla: rendiciones
    descripcion: "Rendición de cuentas de recursos transferidos"
  
  atributos:
    id: { tipo: UUID, pk: true }
    convenio_id: { tipo: "FK(convenios.id)", not_null: true }
    numero: { tipo: Integer, not_null: true }
    tipo:
      tipo: Enum
      valores: [PARCIAL, FINAL, COMPLEMENTARIA]
      not_null: true
      default: PARCIAL
    periodo_desde: { tipo: Date, not_null: true }
    periodo_hasta: { tipo: Date, not_null: true }
    fecha_presentacion: { tipo: Date, nullable: true }
    fecha_recepcion: { tipo: Date, nullable: true }
    monto_rendido: { tipo: Decimal(18,0), not_null: true }
    monto_aprobado: { tipo: Decimal(18,0), default: 0 }
    monto_observado: { tipo: Decimal(18,0), default: 0 }
    monto_rechazado: { tipo: Decimal(18,0), default: 0 }
    cantidad_documentos: { tipo: Integer, default: 0 }
    estado:
      tipo: Enum
      valores: [PENDIENTE, RECIBIDA, EN_REVISION, OBSERVADA, APROBADA, APROBADA_CON_OBSERVACIONES, RECHAZADA]
      not_null: true
      default: PENDIENTE
    fecha_revision: { tipo: Date, nullable: true }
    fecha_cierre: { tipo: Date, nullable: true }
    revisor_id: { tipo: "FK(funcionarios.id)", nullable: true }
    observaciones_generales: { tipo: Text, nullable: true }
    informe_revision_url: { tipo: String(500), nullable: true }
    # Mora
    dias_mora: { tipo: Integer, default: 0 }
    en_mora: { tipo: Boolean, default: false }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [convenio_id, numero], tipo: unique }
    - { campos: [estado], tipo: btree }
    - { campos: [en_mora], tipo: btree }
    - { campos: [fecha_presentacion], tipo: btree }
  
  relaciones:
    convenio: { tipo: "N:1", entidad: Convenio, fk: "rendiciones.convenio_id" }
    revisor: { tipo: "N:1", entidad: Funcionario, fk: "rendiciones.revisor_id" }
    movimientos: { tipo: "1:N", entidad: MovimientoRendicion, fk: "movimientos_rendicion.rendicion_id" }
    observaciones: { tipo: "1:N", entidad: ObservacionRendicion, fk: "observaciones_rendicion.rendicion_id" }
  
  reglas:
    - id: RN-REN-01
      regla: "monto_aprobado + monto_observado + monto_rechazado = monto_rendido"
    - id: RN-REN-02
      regla: "Rendición FINAL solo si avance_fisico=100%"
    - id: RN-REN-03
      regla: "dias_mora se calcula desde fecha_limite según convenio"
    - id: RN-REN-04
      regla: "en_mora=true si dias_mora > 90"

# ═══════════════════════════════════════════════════════════════════════════════
# MOVIMIENTO RENDICIÓN
# ═══════════════════════════════════════════════════════════════════════════════

MovimientoRendicion:
  _meta:
    dominio: D-EJEC
    tabla: movimientos_rendicion
    descripcion: "Línea de gasto en una rendición"
  
  atributos:
    id: { tipo: UUID, pk: true }
    rendicion_id: { tipo: "FK(rendiciones.id)", not_null: true }
    numero_linea: { tipo: Integer, not_null: true }
    tipo_documento:
      tipo: Enum
      valores: [FACTURA, FACTURA_ELECTRONICA, BOLETA, BOLETA_HONORARIOS, VOUCHER, PLANILLA, VALE, OTRO]
      not_null: true
    numero_documento: { tipo: String(50), not_null: true }
    fecha_documento: { tipo: Date, not_null: true }
    proveedor_rut: { tipo: String(12), not_null: true }
    proveedor_nombre: { tipo: String(200), not_null: true }
    descripcion: { tipo: String(500), not_null: true }
    categoria_gasto: { tipo: String(100), nullable: true }
    monto_neto: { tipo: Decimal(18,0), not_null: true }
    monto_iva: { tipo: Decimal(18,0), default: 0 }
    monto_total: { tipo: Decimal(18,0), not_null: true }
    estado:
      tipo: Enum
      valores: [PENDIENTE, VALIDO, OBSERVADO, RECHAZADO]
      not_null: true
      default: PENDIENTE
    motivo_observacion: { tipo: Text, nullable: true }
    documento_url: { tipo: String(500), nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [rendicion_id, numero_linea], tipo: unique }
    - { campos: [tipo_documento, numero_documento], tipo: btree }
    - { campos: [proveedor_rut], tipo: btree }
    - { campos: [estado], tipo: btree }
  
  relaciones:
    rendicion: { tipo: "N:1", entidad: Rendicion, fk: "movimientos_rendicion.rendicion_id" }
  
  reglas:
    - id: RN-MOV-01
      regla: "monto_total = monto_neto + monto_iva"
    - id: RN-MOV-02
      regla: "RUT proveedor debe ser válido"
    - id: RN-MOV-03
      regla: "No duplicar mismo documento en rendiciones del convenio"

# ═══════════════════════════════════════════════════════════════════════════════
# PROYECTO PMO
# ═══════════════════════════════════════════════════════════════════════════════

ProyectoPMO:
  _meta:
    dominio: D-EJEC
    tabla: proyectos_pmo
    descripcion: "Proyecto en torre de control PMO"
  
  atributos:
    id: { tipo: UUID, pk: true }
    convenio_id: { tipo: "FK(convenios.id)", unique: true, not_null: true }
    codigo_pmo: { tipo: String(20), unique: true, not_null: true }
    nombre: { tipo: String(255), not_null: true }
    gerente_proyecto: { tipo: String(200), nullable: true }
    fecha_inicio_real: { tipo: Date, nullable: true }
    fecha_fin_estimada: { tipo: Date, nullable: true }
    fecha_fin_real: { tipo: Date, nullable: true }
    avance_fisico: { tipo: Decimal(5,2), default: 0 }
    avance_financiero: { tipo: Decimal(5,2), default: 0 }
    avance_programado: { tipo: Decimal(5,2), default: 0 }
    desviacion_tiempo: { tipo: Integer, default: 0, descripcion: "Días" }
    desviacion_costo: { tipo: Decimal(18,0), default: 0 }
    semaforo:
      tipo: Enum
      valores: [VERDE, AMARILLO, ROJO, GRIS]
      default: GRIS
    semaforo_tiempo:
      tipo: Enum
      valores: [VERDE, AMARILLO, ROJO]
      default: VERDE
    semaforo_costo:
      tipo: Enum
      valores: [VERDE, AMARILLO, ROJO]
      default: VERDE
    semaforo_alcance:
      tipo: Enum
      valores: [VERDE, AMARILLO, ROJO]
      default: VERDE
    riesgos_identificados: { tipo: Integer, default: 0 }
    riesgos_activos: { tipo: Integer, default: 0 }
    alertas_activas: { tipo: Integer, default: 0 }
    ultimo_reporte: { tipo: Date, nullable: true }
    proxima_revision: { tipo: Date, nullable: true }
    observaciones: { tipo: Text, nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [convenio_id], tipo: unique }
    - { campos: [codigo_pmo], tipo: unique }
    - { campos: [semaforo], tipo: btree }
  
  relaciones:
    convenio: { tipo: "1:1", entidad: Convenio, fk: "proyectos_pmo.convenio_id" }
    alertas: { tipo: "1:N", entidad: AlertaProyecto, fk: "alertas_proyecto.proyecto_pmo_id" }
    reportes: { tipo: "1:N", entidad: ReporteProyecto, fk: "reportes_proyecto.proyecto_pmo_id" }
  
  reglas:
    - id: RN-PMO-01
      regla: "semaforo se calcula de semaforo_tiempo, semaforo_costo, semaforo_alcance"
    - id: RN-PMO-02
      regla: "ROJO si cualquier semáforo específico es ROJO"
    - id: RN-PMO-03
      regla: "AMARILLO si desviacion_tiempo > 30 días o avance < programado - 10%"

# ═══════════════════════════════════════════════════════════════════════════════
# ENTIDADES AUXILIARES D-EJEC
# ═══════════════════════════════════════════════════════════════════════════════

AlertaProyecto:
  _meta:
    tabla: alertas_proyecto
  
  atributos:
    id: { tipo: UUID, pk: true }
    proyecto_pmo_id: { tipo: "FK(proyectos_pmo.id)", not_null: true }
    tipo: 
      tipo: Enum
      valores: [ATRASO, SOBRECOSTO, RIESGO, RENDICION, VENCIMIENTO, OTRO]
    severidad:
      tipo: Enum
      valores: [BAJA, MEDIA, ALTA, CRITICA]
    titulo: { tipo: String(200), not_null: true }
    descripcion: { tipo: Text }
    fecha_generacion: { tipo: DateTime, not_null: true }
    fecha_atencion: { tipo: DateTime, nullable: true }
    estado:
      tipo: Enum
      valores: [ACTIVA, EN_ATENCION, RESUELTA, CERRADA]
    asignado_a: { tipo: "FK(usuarios.id)", nullable: true }
    accion_tomada: { tipo: Text, nullable: true }

ObservacionRendicion:
  _meta:
    tabla: observaciones_rendicion
  
  atributos:
    id: { tipo: UUID, pk: true }
    rendicion_id: { tipo: "FK(rendiciones.id)", not_null: true }
    movimiento_id: { tipo: "FK(movimientos_rendicion.id)", nullable: true }
    tipo:
      tipo: Enum
      valores: [DOCUMENTAL, CALCULO, ELEGIBILIDAD, DUPLICIDAD, OTRO]
    descripcion: { tipo: Text, not_null: true }
    monto_afectado: { tipo: Decimal(18,0), nullable: true }
    estado:
      tipo: Enum
      valores: [PENDIENTE, SUBSANADA, NO_SUBSANADA]
    fecha_observacion: { tipo: DateTime, not_null: true }
    fecha_respuesta: { tipo: DateTime, nullable: true }
    respuesta: { tipo: Text, nullable: true }

# ═══════════════════════════════════════════════════════════════════════════════
# FIN D-EJEC
# ═══════════════════════════════════════════════════════════════════════════════
