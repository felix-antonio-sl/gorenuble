# GOS-700: GORE_OS - Plan de Migración de Datos
# ═══════════════════════════════════════════════════════════════════════════════

Manifest:
  URN: "urn:knowledge:gorenuble:goreos:700:plan_migracion_datos"
  Version: "1.0.0"
  Status: Draft

Metadata:
  Title: "GORE_OS - Plan de Migración de Datos"
  Description: "Estrategia, mapeos y procesos para migración de datos legacy"
  Domain: GORE_OS
  Created: "2024-12-14"
  Tags: [goreos, migracion, datos, etl]

# ═══════════════════════════════════════════════════════════════════════════════
# VISIÓN GENERAL
# ═══════════════════════════════════════════════════════════════════════════════

Vision:
  objetivo: "Migrar datos históricos de sistemas actuales a GORE_OS"
  
  principios:
    - "Cero pérdida de datos críticos"
    - "Trazabilidad de origen de cada registro"
    - "Validación exhaustiva pre y post migración"
    - "Rollback posible en cada etapa"
  
  fuentes_identificadas:
    - { sistema: "Excel DAF", tipo: "Hojas de cálculo", datos: "Cartera IPR, Convenios" }
    - { sistema: "BIP", tipo: "Sistema externo", datos: "Fichas de proyectos" }
    - { sistema: "SIGFE", tipo: "Sistema externo", datos: "Ejecución presupuestaria" }
    - { sistema: "Documentos", tipo: "Archivos", datos: "Convenios PDF, Rendiciones" }
    - { sistema: "Access/Base local", tipo: "Base de datos", datos: "Histórico rendiciones" }

# ═══════════════════════════════════════════════════════════════════════════════
# INVENTARIO DE DATOS
# ═══════════════════════════════════════════════════════════════════════════════

Inventario:

  Entidades_Maestras:
    Territorios:
      fuente: "INE / SUBDERE"
      registros_estimados: 25
      criticidad: ALTA
      estrategia: "Carga inicial desde fuente oficial"
      
    Actores:
      fuente: "Excel DAF + SII"
      registros_estimados: 150
      criticidad: ALTA
      campos_clave: [rut, nombre, tipo, es_unidad_ejecutora]
      limpieza_requerida:
        - "Normalizar RUT (con/sin puntos, DV)"
        - "Eliminar duplicados"
        - "Validar vigencia en SII"
      
    Usuarios:
      fuente: "Nuevo registro"
      registros_estimados: 100
      estrategia: "Creación desde cero con ClaveÚnica"
      
    Unidades_Organicas:
      fuente: "Organigrama GORE"
      registros_estimados: 35
      estrategia: "Carga manual validada con RRHH"

  D_PLAN:
    ERD:
      fuente: "Documento ERD 2021-2028"
      registros_estimados: 1
      estrategia: "Carga manual estructurada"
      
    Objetivos_Estrategicos:
      fuente: "Documento ERD"
      registros_estimados: 25
      estrategia: "Carga manual estructurada"

  D_FIN:
    Iniciativas:
      fuente: "Excel DAF + BIP"
      registros_estimados: 500
      criticidad: ALTA
      campos_clave:
        - codigo_interno
        - codigo_bip
        - nombre
        - costo_total
        - estado
        - beneficiario
        - territorio
        - fecha_rs
        - monto_rs
      limpieza_requerida:
        - "Mapear estados legacy a nuevos estados"
        - "Completar código BIP faltante"
        - "Normalizar montos (CLP sin decimales)"
        - "Vincular a territorios normalizados"
      validaciones:
        - "codigo_bip único si existe"
        - "beneficiario_id existe en actores"
        - "territorio_id existe en territorios"
        - "costo_total > 0"
      
    Solicitudes:
      fuente: "Excel DAF"
      registros_estimados: 800
      campos_clave: [iniciativa, instrumento, anio, monto, estado]
      
    Instrumentos:
      fuente: "Catálogo oficial"
      registros_estimados: 10
      estrategia: "Carga manual desde normativa"
      
    Presupuesto:
      fuente: "SIGFE export"
      registros_estimados: 50 items/año
      estrategia: "Importar último año completo + año actual"

  D_EJEC:
    Convenios:
      fuente: "Excel DAF + Documentos"
      registros_estimados: 200
      criticidad: ALTA
      campos_clave:
        - numero
        - iniciativa_id
        - unidad_ejecutora_id
        - monto_total
        - aporte_gore
        - fecha_suscripcion
        - fecha_termino
        - estado
        - monto_transferido
        - monto_rendido
      limpieza_requerida:
        - "Reconstruir número de convenio estandarizado"
        - "Mapear estados legacy"
        - "Calcular avances físico/financiero"
      validaciones:
        - "iniciativa_id existe"
        - "unidad_ejecutora_id existe y es UE"
        - "monto_total = aporte_gore + aporte_ejecutor"
        
    Rendiciones:
      fuente: "Excel/Access + PDFs"
      registros_estimados: 1500
      criticidad: MEDIA
      estrategia: "Migrar solo resumen, no detalle de movimientos históricos"
      campos_a_migrar:
        - convenio_id
        - numero
        - periodo
        - monto_rendido
        - monto_aprobado
        - estado

# ═══════════════════════════════════════════════════════════════════════════════
# MAPEO DE DATOS
# ═══════════════════════════════════════════════════════════════════════════════

Mapeos:

  Estados_Iniciativa:
    descripcion: "Mapeo de estados legacy a GORE_OS"
    mapeo:
      "IDEA": "IDEA"
      "EN FORMULACION": "PERFIL"
      "PERFIL OK": "PERFIL_TERMINADO"
      "PREFACTIBILIDAD": "PREFACTIBILIDAD"
      "FACTIBILIDAD": "FACTIBILIDAD"
      "DISEÑO": "DISENO"
      "SIN RS": "SIN_RS"
      "EN SNI": "EN_EVALUACION_RS"
      "RS VIGENTE": "CON_RS"
      "RS VENCIDA": "RS_VENCIDA"
      "PRIORIZADO": "PRIORIZADA"
      "APROBADO CORE": "APROBADA_CORE"
      "EN EJECUCIÓN": "EN_EJECUCION"
      "TERMINADO": "FINALIZADA"
      "SUSPENDIDO": "SUSPENDIDA"
      "CANCELADO": "CANCELADA"
    default: "IDEA"
    
  Estados_Convenio:
    mapeo:
      "BORRADOR": "BORRADOR"
      "EN REVISION": "EN_REVISION_JURIDICA"
      "PARA FIRMA": "PARA_FIRMA"
      "VIGENTE": "VIGENTE"
      "TERMINADO": "LIQUIDADO"
      "RESCILIADO": "RESCILIADO"
    default: "VIGENTE"
    
  Estados_Rendicion:
    mapeo:
      "PENDIENTE": "PENDIENTE"
      "PRESENTADA": "RECIBIDA"
      "EN REVISIÓN": "EN_REVISION"
      "OBSERVADA": "OBSERVADA"
      "APROBADA": "APROBADA"
      "RECHAZADA": "RECHAZADA"
    default: "APROBADA"
    
  Tipos_Actor:
    mapeo:
      "MUNICIPALIDAD": "MUNICIPALIDAD"
      "MUNICIPIO": "MUNICIPALIDAD"
      "MUN": "MUNICIPALIDAD"
      "SERVICIO": "SERVICIO_PUBLICO"
      "SERV. PUBLICO": "SERVICIO_PUBLICO"
      "UNIVERSIDAD": "UNIVERSIDAD"
      "CORPORACIÓN": "CORPORACION"
      "FUNDACIÓN": "FUNDACION"
      "ONG": "ONG"
      "EMPRESA": "EMPRESA_PRIVADA"
    default: "OTRO"

# ═══════════════════════════════════════════════════════════════════════════════
# PROCESO DE MIGRACIÓN
# ═══════════════════════════════════════════════════════════════════════════════

Proceso:

  Fases:
    F1_Preparacion:
      duracion: "2 semanas"
      actividades:
        - "Recopilar fuentes de datos"
        - "Analizar calidad de datos"
        - "Documentar mapeos"
        - "Desarrollar scripts ETL"
        - "Crear ambiente de migración"
      entregables:
        - "Inventario de fuentes"
        - "Reporte de calidad de datos"
        - "Scripts ETL versionados"
        
    F2_Limpieza:
      duracion: "2 semanas"
      actividades:
        - "Normalizar RUTs"
        - "Eliminar duplicados"
        - "Completar datos faltantes"
        - "Validar con usuarios"
      entregables:
        - "Archivos fuente limpios"
        - "Log de cambios realizados"
        
    F3_Migracion_Maestras:
      duracion: "1 semana"
      orden:
        1: "Territorios"
        2: "Actores"
        3: "Unidades Orgánicas"
        4: "Instrumentos Financiamiento"
        5: "ERD + Objetivos"
      validaciones:
        - "Conteo de registros"
        - "Integridad referencial"
        - "Muestra aleatoria revisada"
        
    F4_Migracion_Transaccionales:
      duracion: "2 semanas"
      orden:
        1: "Iniciativas"
        2: "Solicitudes"
        3: "Convenios"
        4: "Rendiciones (resumen)"
        5: "Presupuesto"
      dependencias:
        - "Iniciativas requiere Actores + Territorios"
        - "Convenios requiere Iniciativas + Actores"
        - "Rendiciones requiere Convenios"
        
    F5_Validacion:
      duracion: "1 semana"
      actividades:
        - "Validación cruzada con fuentes"
        - "Revisión por usuarios clave"
        - "Corrección de errores"
        - "Aprobación formal"
      criterios_aceptacion:
        - "100% registros críticos migrados"
        - "0 errores de integridad referencial"
        - "< 5% errores menores corregibles"
        
    F6_Cutover:
      duracion: "1 día"
      actividades:
        - "Congelar sistemas fuente"
        - "Migración delta (últimos cambios)"
        - "Activar GORE_OS en producción"
        - "Comunicar a usuarios"

# ═══════════════════════════════════════════════════════════════════════════════
# SCRIPTS ETL
# ═══════════════════════════════════════════════════════════════════════════════

ETL_Scripts:

  Iniciativas:
    fuente: "iniciativas_daf.xlsx"
    destino: "tabla iniciativas"
    
    pseudocodigo: |
      1. Leer Excel con pandas
      2. Normalizar columnas (lowercase, trim)
      3. Para cada fila:
         a. Normalizar RUT beneficiario
         b. Buscar/crear actor en BD
         c. Mapear territorio por comuna
         d. Mapear estado según tabla
         e. Parsear fechas
         f. Calcular vigencia RS si tiene fecha_rs
         g. Generar codigo_interno si no existe
         h. Insertar en BD
         i. Registrar en log de migración
      4. Generar reporte de migración
    
    ejemplo_python: |
      # scripts/migrate_iniciativas.py
      import pandas as pd
      from prisma import Prisma
      from utils import normalizar_rut, mapear_estado, parsear_fecha
      
      async def migrate_iniciativas(file_path: str):
          db = Prisma()
          await db.connect()
          
          df = pd.read_excel(file_path)
          df.columns = df.columns.str.lower().str.strip()
          
          migrated = 0
          errors = []
          
          for idx, row in df.iterrows():
              try:
                  # Buscar actor
                  rut = normalizar_rut(row['rut_beneficiario'])
                  actor = await db.actor.find_first(where={'rut': rut})
                  if not actor:
                      errors.append(f"Row {idx}: Actor no encontrado {rut}")
                      continue
                  
                  # Buscar territorio
                  territorio = await db.territorio.find_first(
                      where={'nombre': {'contains': row['comuna']}}
                  )
                  
                  # Crear iniciativa
                  await db.iniciativa.create(data={
                      'codigoInterno': generar_codigo(idx),
                      'codigoBip': row.get('codigo_bip'),
                      'nombre': row['nombre'],
                      'tipo': 'PROYECTO',
                      'sector': row['sector'],
                      'costoTotal': int(row['costo_total']),
                      'estado': mapear_estado(row['estado']),
                      'beneficiarioId': actor.id,
                      'territorioId': territorio.id if territorio else None,
                      'fechaRs': parsear_fecha(row.get('fecha_rs')),
                  })
                  migrated += 1
                  
              except Exception as e:
                  errors.append(f"Row {idx}: {str(e)}")
          
          return {'migrated': migrated, 'errors': errors}

  Convenios:
    pseudocodigo: |
      1. Leer Excel convenios
      2. Para cada convenio:
         a. Buscar iniciativa por código BIP o nombre
         b. Buscar actor ejecutor por RUT
         c. Calcular montos y avances
         d. Mapear estado
         e. Insertar convenio
         f. Crear hitos si hay información
         g. Crear desembolsos históricos
      3. Actualizar totales de iniciativa

# ═══════════════════════════════════════════════════════════════════════════════
# VALIDACIONES
# ═══════════════════════════════════════════════════════════════════════════════

Validaciones:

  Pre_Migracion:
    - nombre: "Completitud de datos críticos"
      query: "SELECT COUNT(*) WHERE campo_critico IS NULL"
      umbral: "< 5%"
      
    - nombre: "RUTs válidos"
      validacion: "Verificar dígito verificador"
      umbral: "100%"
      
    - nombre: "Montos coherentes"
      validacion: "costo_total > 0, monto_rs <= costo_total"
      umbral: "100%"

  Post_Migracion:
    - nombre: "Conteo de registros"
      validacion: "COUNT(destino) >= COUNT(fuente)"
      por_entidad: true
      
    - nombre: "Integridad referencial"
      validacion: "Todas las FK apuntan a registros existentes"
      umbral: "100%"
      
    - nombre: "Suma de montos"
      validacion: "SUM(monto) destino = SUM(monto) fuente"
      tolerancia: "< 0.01%"
      
    - nombre: "Muestra aleatoria"
      validacion: "Revisar 50 registros aleatorios manualmente"
      aprobacion: "Usuario clave"

  Reconciliacion:
    reporte: |
      REPORTE DE RECONCILIACIÓN MIGRACIÓN
      ════════════════════════════════════
      Entidad: Iniciativas
      Fecha: 2025-03-01
      
      Fuente:                     500 registros
      Migrados exitosamente:      485 registros
      Errores:                     15 registros
      
      Suma montos fuente:    $125.000.000.000
      Suma montos destino:   $125.000.000.000
      Diferencia:                        $0
      
      Errores por tipo:
      - Actor no encontrado:        8
      - Territorio no mapeado:      4
      - Fecha inválida:             3
      
      Estado: PENDIENTE CORRECCIÓN

# ═══════════════════════════════════════════════════════════════════════════════
# ROLLBACK
# ═══════════════════════════════════════════════════════════════════════════════

Rollback:
  
  estrategia: "Backup + Transacciones"
  
  puntos_restauracion:
    - "Pre-migración maestras"
    - "Post-migración maestras"
    - "Pre-migración transaccionales"
    - "Post-migración convenios"
    - "Pre-cutover"
  
  procedimiento: |
    1. Identificar punto de falla
    2. Detener migración
    3. Restaurar backup del punto anterior
    4. Analizar causa de error
    5. Corregir y reintentar

# ═══════════════════════════════════════════════════════════════════════════════
# CRONOGRAMA
# ═══════════════════════════════════════════════════════════════════════════════

Cronograma: |
  
  Semana 1-2:  [████████] Preparación y análisis
  Semana 3-4:  [████████] Limpieza de datos
  Semana 5:    [████]     Migración maestras
  Semana 6-7:  [████████] Migración transaccionales
  Semana 8:    [████]     Validación y correcciones
  Semana 9:    [██]       Cutover y go-live

# ═══════════════════════════════════════════════════════════════════════════════
# FIN GOS-700
# ═══════════════════════════════════════════════════════════════════════════════
