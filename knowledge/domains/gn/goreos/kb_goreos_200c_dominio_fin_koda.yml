# GOS-200c: GORE_OS - Modelo de Datos: Dominio Financiamiento (D-FIN)
# ═══════════════════════════════════════════════════════════════════════════════

Manifest:
  URN: "urn:knowledge:gorenuble:goreos:200c:modelo_datos:d_fin"
  Version: "1.0.0"
  Status: Draft

Metadata:
  Title: "GORE_OS - Modelo de Datos: D-FIN (Financiamiento)"
  Description: "Detalle de las 6 entidades del dominio Financiamiento"
  Domain: GORE_OS
  Created: "2024-12-14"
  Ref: "kb_goreos_200_modelo_datos_esqueleto_koda.yml"
  Tags: [goreos, modelo_datos, d_fin, iniciativa, presupuesto]

# ═══════════════════════════════════════════════════════════════════════════════
# INICIATIVA
# ═══════════════════════════════════════════════════════════════════════════════

Iniciativa:
  _meta:
    dominio: D-FIN
    tabla: iniciativas
    descripcion: "Proyecto, programa o estudio de inversión pública regional"
  
  atributos:
    id: { tipo: UUID, pk: true }
    codigo_interno: { tipo: String(20), unique: true, not_null: true }
    codigo_bip: { tipo: String(15), unique: true, nullable: true }
    nombre: { tipo: String(500), not_null: true }
    descripcion: { tipo: Text, nullable: true }
    tipo:
      tipo: Enum
      valores: [PROYECTO, PROGRAMA, ESTUDIO_BASICO, ESTUDIO_PREINVERSION]
      not_null: true
    subtipo: { tipo: String(100), nullable: true }
    sector: { tipo: String(100), not_null: true }
    subsector: { tipo: String(100), nullable: true }
    costo_total: { tipo: Decimal(18,0), not_null: true }
    costo_actualizado: { tipo: Decimal(18,0), nullable: true }
    fecha_actualizacion_costo: { tipo: Date, nullable: true }
    estado:
      tipo: Enum
      valores: [IDEA, PERFIL, PERFIL_TERMINADO, PREFACTIBILIDAD, FACTIBILIDAD, DISEÑO, SIN_RS, EN_EVALUACION_RS, CON_RS, RS_VENCIDA, PRIORIZADA, EN_SESION_CORE, APROBADA_CORE, RECHAZADA_CORE, EN_EJECUCION, FINALIZADA, SUSPENDIDA, CANCELADA]
      not_null: true
      default: IDEA
    etapa_bip:
      tipo: Enum
      valores: [PREINVERSION, EJECUCION, OPERACION]
      nullable: true
    # RS (Recomendación SNI)
    fecha_rs: { tipo: Date, nullable: true }
    numero_rs: { tipo: String(50), nullable: true }
    monto_rs: { tipo: Decimal(18,0), nullable: true }
    vigencia_rs: { tipo: Date, nullable: true }
    # Relaciones
    beneficiario_id: { tipo: "FK(actores.id)", not_null: true }
    territorio_id: { tipo: "FK(territorios.id)", not_null: true }
    objetivo_erd_id: { tipo: "FK(objetivos_estrategicos.id)", nullable: true }
    convenio_programacion_id: { tipo: "FK(convenios_programacion.id)", nullable: true }
    erd_id: { tipo: "FK(erds.id)", nullable: true }
    # Georreferenciación
    coordenadas: { tipo: "Geometry(Point, 4326)", nullable: true }
    area_influencia: { tipo: "Geometry(MultiPolygon, 4326)", nullable: true }
    # Metadatos
    fuente_financiamiento_preferida: { tipo: String(50), nullable: true }
    prioridad_regional: { tipo: Integer, nullable: true }
    justificacion: { tipo: Text, nullable: true }
    poblacion_beneficiaria: { tipo: Integer, nullable: true }
    empleos_directos: { tipo: Integer, nullable: true }
    empleos_indirectos: { tipo: Integer, nullable: true }
    ficha_idi_url: { tipo: String(500), nullable: true }
    # Auditoría
    created_by: { tipo: "FK(usuarios.id)", nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_by: { tipo: "FK(usuarios.id)", nullable: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [codigo_interno], tipo: unique }
    - { campos: [codigo_bip], tipo: unique, where: "codigo_bip IS NOT NULL" }
    - { campos: [estado], tipo: btree }
    - { campos: [beneficiario_id], tipo: btree }
    - { campos: [territorio_id], tipo: btree }
    - { campos: [sector, subsector], tipo: btree }
    - { campos: [objetivo_erd_id], tipo: btree }
    - { campos: [coordenadas], tipo: gist }
  
  relaciones:
    beneficiario: { tipo: "N:1", entidad: Actor, fk: "iniciativas.beneficiario_id" }
    territorio: { tipo: "N:1", entidad: Territorio, fk: "iniciativas.territorio_id" }
    objetivo_erd: { tipo: "N:1", entidad: ObjetivoEstrategico, fk: "iniciativas.objetivo_erd_id" }
    convenio_programacion: { tipo: "N:1", entidad: ConvenioProgramacion, fk: "iniciativas.convenio_programacion_id" }
    solicitudes: { tipo: "1:N", entidad: SolicitudFinanciamiento, fk: "solicitudes_financiamiento.iniciativa_id" }
    convenios: { tipo: "1:N", entidad: Convenio, fk: "convenios.iniciativa_id" }
    documentos: { tipo: "1:N", entidad: DocumentoIniciativa, fk: "documentos_iniciativa.iniciativa_id" }
    historial: { tipo: "1:N", entidad: HistorialEstadoIniciativa, fk: "historial_estado_iniciativa.iniciativa_id" }
  
  reglas:
    - id: RN-INI-01
      regla: "codigo_bip obligatorio si estado >= EN_EVALUACION_RS"
    - id: RN-INI-02
      regla: "fecha_rs, numero_rs obligatorios si estado = CON_RS"
    - id: RN-INI-03
      regla: "RS vence a los 3 años si no se ejecuta"
    - id: RN-INI-04
      regla: "Cambios de estado se registran en historial"
    - id: RN-INI-05
      regla: "Monto convenios no puede exceder costo_total"

# ═══════════════════════════════════════════════════════════════════════════════
# INSTRUMENTO DE FINANCIAMIENTO
# ═══════════════════════════════════════════════════════════════════════════════

InstrumentoFinanciamiento:
  _meta:
    dominio: D-FIN
    tabla: instrumentos_financiamiento
    descripcion: "Fondo o programa de financiamiento regional"
  
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(20), unique: true, not_null: true }
    nombre: { tipo: String(200), not_null: true }
    nombre_corto: { tipo: String(50), nullable: true }
    descripcion: { tipo: Text, nullable: true }
    tipo:
      tipo: Enum
      valores: [FNDR, FRIL, PMU, PMB, FRPD, CONV_PROG, SUBVENCION, FIC, FAGEM, OTRO]
      not_null: true
    subtipo_presupuestario: { tipo: String(10), not_null: true }
    item_presupuestario: { tipo: String(10), nullable: true }
    requiere_rs: { tipo: Boolean, default: true }
    requiere_aprobacion_core: { tipo: Boolean, default: true }
    monto_maximo: { tipo: Decimal(18,0), nullable: true }
    monto_minimo: { tipo: Decimal(18,0), nullable: true }
    porcentaje_financiamiento_max: { tipo: Decimal(5,2), default: 100 }
    elegibilidad: { tipo: JSONB, nullable: true }
    tipos_beneficiario:
      tipo: JSONB
      descripcion: "Array de tipos de actor elegibles"
    sectores_elegibles: { tipo: JSONB, nullable: true }
    documentos_requeridos: { tipo: JSONB, nullable: true }
    normativa_aplicable: { tipo: Text, nullable: true }
    vigente: { tipo: Boolean, default: true }
    anio_inicio: { tipo: Integer, nullable: true }
    anio_termino: { tipo: Integer, nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [tipo, vigente], tipo: btree }
  
  relaciones:
    solicitudes: { tipo: "1:N", entidad: SolicitudFinanciamiento, fk: "solicitudes_financiamiento.instrumento_id" }
    items_presupuestarios: { tipo: "1:N", entidad: ItemPresupuestario, fk: "items_presupuestarios.instrumento_id" }
  
  instrumentos_base:
    - { codigo: FNDR, nombre: "Fondo Nacional de Desarrollo Regional", requiere_rs: true }
    - { codigo: FRIL, nombre: "Fondo Regional de Inversión Local", requiere_rs: true }
    - { codigo: PMU, nombre: "Programa de Mejoramiento Urbano", requiere_rs: true }
    - { codigo: PMB, nombre: "Programa de Mejoramiento de Barrios", requiere_rs: true }
    - { codigo: FRPD, nombre: "Fondo Regional de Productividad y Diversificación", requiere_rs: false }
    - { codigo: SUB8, nombre: "Subvención 8% Ley 19.175", requiere_rs: false }

# ═══════════════════════════════════════════════════════════════════════════════
# SOLICITUD DE FINANCIAMIENTO
# ═══════════════════════════════════════════════════════════════════════════════

SolicitudFinanciamiento:
  _meta:
    dominio: D-FIN
    tabla: solicitudes_financiamiento
    descripcion: "Solicitud de financiamiento de una iniciativa"
  
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(30), unique: true, not_null: true }
    iniciativa_id: { tipo: "FK(iniciativas.id)", not_null: true }
    instrumento_id: { tipo: "FK(instrumentos_financiamiento.id)", not_null: true }
    priorizacion_id: { tipo: "FK(priorizaciones.id)", nullable: true }
    anio_solicitado: { tipo: Integer, not_null: true }
    monto_solicitado: { tipo: Decimal(18,0), not_null: true }
    monto_aprobado: { tipo: Decimal(18,0), nullable: true }
    aporte_beneficiario: { tipo: Decimal(18,0), default: 0 }
    estado:
      tipo: Enum
      valores: [BORRADOR, PRESENTADA, EN_EVALUACION, ELEGIBLE, NO_ELEGIBLE, PRIORIZADA, NO_PRIORIZADA, EN_SESION_CORE, APROBADA_CORE, RECHAZADA_CORE, DESISTIDA]
      not_null: true
      default: BORRADOR
    fecha_presentacion: { tipo: Date, nullable: true }
    fecha_evaluacion: { tipo: Date, nullable: true }
    puntaje_evaluacion: { tipo: Decimal(5,2), nullable: true }
    ranking_priorizacion: { tipo: Integer, nullable: true }
    fecha_sesion_core: { tipo: Date, nullable: true }
    acuerdo_core: { tipo: String(50), nullable: true }
    fecha_aprobacion_core: { tipo: Date, nullable: true }
    observaciones: { tipo: Text, nullable: true }
    motivo_rechazo: { tipo: Text, nullable: true }
    # Auditoría
    created_by: { tipo: "FK(usuarios.id)", nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [iniciativa_id, instrumento_id, anio_solicitado], tipo: unique }
    - { campos: [estado], tipo: btree }
    - { campos: [instrumento_id, anio_solicitado], tipo: btree }
    - { campos: [priorizacion_id, ranking_priorizacion], tipo: btree }
  
  relaciones:
    iniciativa: { tipo: "N:1", entidad: Iniciativa, fk: "solicitudes_financiamiento.iniciativa_id" }
    instrumento: { tipo: "N:1", entidad: InstrumentoFinanciamiento, fk: "solicitudes_financiamiento.instrumento_id" }
    priorizacion: { tipo: "N:1", entidad: Priorizacion, fk: "solicitudes_financiamiento.priorizacion_id" }
    documentos: { tipo: "1:N", entidad: DocumentoSolicitud, fk: "documentos_solicitud.solicitud_id" }
  
  reglas:
    - id: RN-SOL-01
      regla: "Una iniciativa solo puede tener una solicitud activa por instrumento/año"
    - id: RN-SOL-02
      regla: "monto_aprobado <= monto_solicitado"
    - id: RN-SOL-03
      regla: "Estado APROBADA_CORE requiere acuerdo_core"
    - id: RN-SOL-04
      regla: "Iniciativa debe tener RS vigente si instrumento.requiere_rs=true"

# ═══════════════════════════════════════════════════════════════════════════════
# PRESUPUESTO
# ═══════════════════════════════════════════════════════════════════════════════

Presupuesto:
  _meta:
    dominio: D-FIN
    tabla: presupuestos
    descripcion: "Presupuesto regional por período"
  
  atributos:
    id: { tipo: UUID, pk: true }
    periodo_id: { tipo: "FK(periodos.id)", not_null: true }
    tipo:
      tipo: Enum
      valores: [INICIAL, VIGENTE]
      not_null: true
    version: { tipo: Integer, default: 1 }
    monto_total: { tipo: Decimal(18,0), not_null: true }
    monto_inversion: { tipo: Decimal(18,0), not_null: true }
    monto_funcionamiento: { tipo: Decimal(18,0), not_null: true }
    fecha_aprobacion: { tipo: Date, nullable: true }
    resolucion: { tipo: String(50), nullable: true }
    descripcion: { tipo: Text, nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [periodo_id, tipo, version], tipo: unique }
  
  relaciones:
    periodo: { tipo: "N:1", entidad: Periodo, fk: "presupuestos.periodo_id" }
    items: { tipo: "1:N", entidad: ItemPresupuestario, fk: "items_presupuestarios.presupuesto_id" }
  
  reglas:
    - id: RN-PRE-01
      regla: "monto_total = monto_inversion + monto_funcionamiento"
    - id: RN-PRE-02
      regla: "Suma de items debe igualar monto_total"

# ═══════════════════════════════════════════════════════════════════════════════
# ITEM PRESUPUESTARIO
# ═══════════════════════════════════════════════════════════════════════════════

ItemPresupuestario:
  _meta:
    dominio: D-FIN
    tabla: items_presupuestarios
    descripcion: "Línea de presupuesto"
  
  atributos:
    id: { tipo: UUID, pk: true }
    presupuesto_id: { tipo: "FK(presupuestos.id)", not_null: true }
    instrumento_id: { tipo: "FK(instrumentos_financiamiento.id)", nullable: true }
    subtitulo: { tipo: String(10), not_null: true }
    item: { tipo: String(10), not_null: true }
    asignacion: { tipo: String(10), nullable: true }
    subasignacion: { tipo: String(10), nullable: true }
    descripcion: { tipo: String(500), not_null: true }
    monto_inicial: { tipo: Decimal(18,0), not_null: true }
    monto_vigente: { tipo: Decimal(18,0), not_null: true }
    monto_comprometido: { tipo: Decimal(18,0), default: 0 }
    monto_devengado: { tipo: Decimal(18,0), default: 0 }
    monto_pagado: { tipo: Decimal(18,0), default: 0 }
    monto_por_devengar: { tipo: Decimal(18,0), default: 0, descripcion: "Calculado" }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [presupuesto_id, subtitulo, item, asignacion], tipo: unique }
    - { campos: [instrumento_id], tipo: btree }
  
  relaciones:
    presupuesto: { tipo: "N:1", entidad: Presupuesto, fk: "items_presupuestarios.presupuesto_id" }
    instrumento: { tipo: "N:1", entidad: InstrumentoFinanciamiento, fk: "items_presupuestarios.instrumento_id" }
  
  reglas:
    - id: RN-ITP-01
      regla: "monto_por_devengar = monto_vigente - monto_devengado"
    - id: RN-ITP-02
      regla: "monto_devengado <= monto_vigente"
    - id: RN-ITP-03
      regla: "monto_pagado <= monto_devengado"

# ═══════════════════════════════════════════════════════════════════════════════
# PRIORIZACIÓN
# ═══════════════════════════════════════════════════════════════════════════════

Priorizacion:
  _meta:
    dominio: D-FIN
    tabla: priorizaciones
    descripcion: "Proceso de priorización de cartera"
  
  atributos:
    id: { tipo: UUID, pk: true }
    codigo: { tipo: String(30), unique: true, not_null: true }
    nombre: { tipo: String(200), not_null: true }
    anio: { tipo: Integer, not_null: true }
    instrumento_id: { tipo: "FK(instrumentos_financiamiento.id)", nullable: true }
    fecha_inicio: { tipo: Date, not_null: true }
    fecha_cierre: { tipo: Date, not_null: true }
    fecha_evaluacion: { tipo: Date, nullable: true }
    fecha_sesion_core: { tipo: Date, nullable: true }
    estado:
      tipo: Enum
      valores: [PROGRAMADA, RECEPCION, EVALUACION, PRIORIZACION, SESION_CORE, CERRADA, CANCELADA]
      not_null: true
      default: PROGRAMADA
    criterios_evaluacion: { tipo: JSONB, nullable: true }
    marco_presupuestario: { tipo: Decimal(18,0), nullable: true }
    total_solicitado: { tipo: Decimal(18,0), default: 0 }
    total_aprobado: { tipo: Decimal(18,0), default: 0 }
    cantidad_solicitudes: { tipo: Integer, default: 0 }
    cantidad_aprobadas: { tipo: Integer, default: 0 }
    observaciones: { tipo: Text, nullable: true }
    created_at: { tipo: DateTime, auto: true }
    updated_at: { tipo: DateTime, auto: true }
  
  indices:
    - { campos: [codigo], tipo: unique }
    - { campos: [anio, instrumento_id], tipo: btree }
    - { campos: [estado], tipo: btree }
  
  relaciones:
    instrumento: { tipo: "N:1", entidad: InstrumentoFinanciamiento, fk: "priorizaciones.instrumento_id" }
    solicitudes: { tipo: "1:N", entidad: SolicitudFinanciamiento, fk: "solicitudes_financiamiento.priorizacion_id" }
  
  reglas:
    - id: RN-PRI-01
      regla: "fecha_cierre >= fecha_inicio"
    - id: RN-PRI-02
      regla: "total_aprobado <= marco_presupuestario"

# ═══════════════════════════════════════════════════════════════════════════════
# ENTIDADES AUXILIARES D-FIN
# ═══════════════════════════════════════════════════════════════════════════════

DocumentoIniciativa:
  _meta:
    tabla: documentos_iniciativa
    descripcion: "Documento asociado a una iniciativa"
  
  atributos:
    id: { tipo: UUID, pk: true }
    iniciativa_id: { tipo: "FK(iniciativas.id)", not_null: true }
    tipo:
      tipo: Enum
      valores: [FICHA_IDI, PERFIL, PREFACTIBILIDAD, FACTIBILIDAD, DISEÑO, RS, PLANO, PRESUPUESTO, OTRO]
    nombre: { tipo: String(255), not_null: true }
    archivo_url: { tipo: String(500), not_null: true }
    fecha_documento: { tipo: Date, nullable: true }
    created_at: { tipo: DateTime, auto: true }

HistorialEstadoIniciativa:
  _meta:
    tabla: historial_estado_iniciativa
    descripcion: "Historial de cambios de estado de iniciativa"
  
  atributos:
    id: { tipo: UUID, pk: true }
    iniciativa_id: { tipo: "FK(iniciativas.id)", not_null: true }
    estado_anterior: { tipo: String(50), nullable: true }
    estado_nuevo: { tipo: String(50), not_null: true }
    fecha_cambio: { tipo: DateTime, not_null: true }
    usuario_id: { tipo: "FK(usuarios.id)", not_null: true }
    motivo: { tipo: Text, nullable: true }

# ═══════════════════════════════════════════════════════════════════════════════
# FIN D-FIN
# ═══════════════════════════════════════════════════════════════════════════════
